"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _spinalEnvViewerGraphService = require("spinal-env-viewer-graph-service");

var _service = require("spinal-env-viewer-room-manager/js/service");

var _visit = require("./visit.model");

var _visit2 = _interopRequireDefault(_visit);

var _spinalCoreConnectorjs_type = require("spinal-core-connectorjs_type");

var _vuePropertyDecorator = require("vue-property-decorator");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

// import OperationModel from "./operationModel";
// import VisitModel from "./visitModel";

class SpinalVisitService {
  constructor() {
    this.VISIT_CONTEXT_NAME = ".visit_context";
    this.CONTEXT_TYPE = "visit_context";

    this.VISIT_TYPE = "visit";

    this.MAINTENANCE_VISIT = "MAINTENANCE_VISIT";
    this.REGULATORY_VISIT = "REGULATORY_VISIT";
    this.SECURITY_VISIT = "SECURITY_VISIT";
    this.DIAGNOSTIC_VISIT = "DIAGNOSTIC_VISIT";

    this.VISITS = Object.freeze([{
      type: this.MAINTENANCE_VISIT,
      name: "Maintenace visit"
    }, {
      type: this.REGULATORY_VISIT,
      name: "Regulatory visit"
    }, {
      type: this.SECURITY_VISIT,
      name: "Security Visit"
    }, {
      type: this.DIAGNOSTIC_VISIT,
      name: "Diagnostic visit"
    }]);

    //RELATIONS
    this.CONTEXT_TO_VISIT_RELATION = "hasVisit";
    this.GROUP_TO_TASK = "hasTask";

    this.VISIT_TO_TASK_RELATION = "hasVisitTask";
    this.TASK_TO_STATE = "hasState";

    this._init();
  }

  _init() {
    _spinalEnvViewerGraphService.SpinalGraphService.waitForInitialization().then(() => {
      let context = _spinalEnvViewerGraphService.SpinalGraphService.getContext(this.VISIT_CONTEXT_NAME);

      if (typeof context !== "undefined") return;

      _spinalEnvViewerGraphService.SpinalGraphService.addContext(this.VISIT_CONTEXT_NAME, this.CONTEXT_TYPE, new _vuePropertyDecorator.Model({
        name: this.VISIT_CONTEXT_NAME
      })).then(contextCreated => {
        let contextId = contextCreated.getId().get();

        this.VISITS.forEach(el => {
          let nodeId = _spinalEnvViewerGraphService.SpinalGraphService.createNode({
            name: el.name,
            type: el.type
          }, new _vuePropertyDecorator.Model({
            name: el
          }));

          _spinalEnvViewerGraphService.SpinalGraphService.addChildInContext(contextId, nodeId, contextId, this.CONTEXT_TO_VISIT_RELATION, _spinalEnvViewerGraphService.SPINAL_RELATION_PTR_LST_TYPE);
        });
      });
    });
  }

  getAllVisits() {
    let context = _spinalEnvViewerGraphService.SpinalGraphService.getContext(this.VISIT_CONTEXT_NAME);

    if (typeof context === "undefined") return Promise.resolve([]);

    let contextId = context.getId().get();

    return _spinalEnvViewerGraphService.SpinalGraphService.getChildren(contextId, [this.CONTEXT_TO_VISIT_RELATION]);
  }

  addTaskOnGroup(groupId, taskName, periodicityNumber, periodicityMesure, visitId, interventionNumber, interventionMesure, description) {

    let visitName = _spinalEnvViewerGraphService.SpinalGraphService.getInfo(visitId).type.get();

    return _spinalEnvViewerGraphService.SpinalGraphService.getChildren(groupId, [this.GROUP_TO_TASK]).then(children => {

      let argNodeId;
      if (children.length === 0) {
        argNodeId = _spinalEnvViewerGraphService.SpinalGraphService.createNode({
          name: "maintenance"
        });

        _spinalEnvViewerGraphService.SpinalGraphService.addChild(groupId, argNodeId, this.GROUP_TO_TASK, _spinalEnvViewerGraphService.SPINAL_RELATION_PTR_LST_TYPE);
      }

      let node = typeof argNodeId !== "undefined" ? _spinalEnvViewerGraphService.SpinalGraphService.getInfo(argNodeId) : children[0];

      return this.getPtrValue(node, visitName).then(lst => {

        let nodeId = this._prepareNode(groupId, taskName, periodicityNumber, periodicityMesure, visitId, visitName, interventionNumber, interventionMesure, description);

        _spinalEnvViewerGraphService.SpinalGraphService.addChild(visitId, nodeId, this.VISIT_TO_TASK_RELATION, _spinalEnvViewerGraphService.SPINAL_RELATION_PTR_LST_TYPE);

        let realNode = _spinalEnvViewerGraphService.SpinalGraphService.getRealNode(nodeId);

        lst.push(realNode);

        return realNode.info;
      });
    });

    // let task = new VisitModel(taskName, beginDate, periodicityNumber,
    //   periodicityMesure,
    //   visitId, visitName);

    // let nodeId = SpinalGraphService.createNode({
    //   name: taskName,
    //   type: "task",
    //   visitId: visitId
    // }, task);

    // // return SpinalGraphService.addChild(groupId, nodeId, this.GROUP_TO_TASK,
    // //   SPINAL_RELATION_PTR_LST_TYPE).then(el => {
    // //   if (el) {
    // //     this.addOperations(groupId, nodeId, beginDate);
    // //     return task;
    // //   }
    // // })
  }

  getPtrValue(node, ptrName) {
    let realNode = _spinalEnvViewerGraphService.SpinalGraphService.getRealNode(node.id.get());

    return new Promise(resolve => {
      if (!realNode.info[ptrName]) {
        realNode.info.add_attr(ptrName, new _spinalCoreConnectorjs_type.Ptr(new _spinalCoreConnectorjs_type.Lst()));
      }

      realNode.info[ptrName].load(value => {
        return resolve(value);
      });
    });
  }

  getGroupTasks(groupId, visityType) {
    return _spinalEnvViewerGraphService.SpinalGraphService.getChildren(groupId, [this.GROUP_TO_TASK]).then(res => {
      let nodeId;
      if (res.length === 0) {
        nodeId = _spinalEnvViewerGraphService.SpinalGraphService.createNode({
          name: "maintenance"
        });

        _spinalEnvViewerGraphService.SpinalGraphService.addChild(groupId, nodeId, this.GROUP_TO_TASK, _spinalEnvViewerGraphService.SPINAL_RELATION_PTR_LST_TYPE);
      }

      let node = typeof nodeId !== "undefined" ? _spinalEnvViewerGraphService.SpinalGraphService.getInfo(nodeId) : res[0];

      return this.getPtrValue(node, visityType);
    });
  }

  _prepareNode(groupId, taskName, periodicityNumber, periodicityMesure, visitId, visitName, interventionNumber, interventionMesure, description) {

    let task = new _visit2.default(taskName, periodicityNumber, periodicityMesure, visitId, visitName, interventionNumber, interventionMesure, description);

    let nodeId = _spinalEnvViewerGraphService.SpinalGraphService.createNode({
      groupId: groupId,
      name: taskName,
      periodicity: {
        number: task.periodicity.number.get(),
        mesure: task.periodicity.mesure.get()
      },
      intervention: {
        number: task.intervention.number.get(),
        mesure: task.intervention.mesure.get()
      },
      visitId: visitId,
      visitType: visitName,
      description: description

    }, task);

    let stateNodeId = _spinalEnvViewerGraphService.SpinalGraphService.createNode({
      name: "state"
    }, new _vuePropertyDecorator.Model({
      name: "state"
    }));

    _spinalEnvViewerGraphService.SpinalGraphService.addChild(nodeId, stateNodeId, this.TASK_TO_STATE, _spinalEnvViewerGraphService.SPINAL_RELATION_PTR_LST_TYPE);

    let realNode = _spinalEnvViewerGraphService.SpinalGraphService.getRealNode(stateNodeId);

    ["Processing", "Validated", "Invalidated"].forEach(el => {
      realNode.info.add_attr([el], new _spinalCoreConnectorjs_type.Ptr(new _spinalCoreConnectorjs_type.Lst()));
    });

    return nodeId;
  }

  // addOperations(groupId, taskId, date) {
  //   Promise.all([SpinalGraphService.getInfo(taskId).element.load(),
  //     SpinalGraphService.getChildren(
  //       groupId, [EQUIPMENTS_TO_ELEMENT_RELATION])
  //   ]).then(async values => {
  //     let visit = new VisitModel(date);

  //     let taskOperations = await values[0].operations.data.model;

  //     values[1].forEach(el => {
  //       visit.bims.push(new OperationModel(el.name.get(), el.dbid
  //         .get()))
  //     });

  //     taskOperations.push(visit);

  //   })
  // }

  // getGroupOperation(nodeId) {
  //   let nodeInfo = SpinalGraphService.getInfo(nodeId);

  //   if (nodeInfo.type.get() === EQUIPMENTS_GROUP) {
  //     return this.getGroupTasks(nodeId).then(tasks => {
  //       let promises = tasks.map(async el => {
  //         return {
  //           taskId: el.id.get(),
  //           taskName: el.name.get(),
  //           operations: (await this.getTaskOperations(el.id.get()))
  //             .get()
  //         };
  //       })

  //       return Promise.all(promises);
  //     })
  //   } else {
  //     return Promise.resolve([]);
  //   }

  // }

  // getTaskOperations(taskId, operationDate) {
  //   let info = SpinalGraphService.getInfo(taskId);
  //   return info.element.load().then(element => {
  //     return new Promise((resolve) => {
  //       element.operations.load((operations) => {
  //         if (typeof operationDate === "undefined") {
  //           resolve(operations);
  //         } else {
  //           for (let i = 0; i < operations.length; i++) {
  //             const operation = operations[i];
  //             if (operation.date.get().toString() ===
  //               operationDate
  //               .toString()) {
  //               resolve(operation[i]);
  //             }
  //           }
  //         }
  //       })
  //     })
  //   })
  // }
}

let spinalVisitService = new SpinalVisitService();

exports.default = spinalVisitService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJTcGluYWxWaXNpdFNlcnZpY2UiLCJjb25zdHJ1Y3RvciIsIlZJU0lUX0NPTlRFWFRfTkFNRSIsIkNPTlRFWFRfVFlQRSIsIlZJU0lUX1RZUEUiLCJNQUlOVEVOQU5DRV9WSVNJVCIsIlJFR1VMQVRPUllfVklTSVQiLCJTRUNVUklUWV9WSVNJVCIsIkRJQUdOT1NUSUNfVklTSVQiLCJWSVNJVFMiLCJPYmplY3QiLCJmcmVlemUiLCJ0eXBlIiwibmFtZSIsIkNPTlRFWFRfVE9fVklTSVRfUkVMQVRJT04iLCJHUk9VUF9UT19UQVNLIiwiVklTSVRfVE9fVEFTS19SRUxBVElPTiIsIlRBU0tfVE9fU1RBVEUiLCJfaW5pdCIsIlNwaW5hbEdyYXBoU2VydmljZSIsIndhaXRGb3JJbml0aWFsaXphdGlvbiIsInRoZW4iLCJjb250ZXh0IiwiZ2V0Q29udGV4dCIsImFkZENvbnRleHQiLCJNb2RlbCIsImNvbnRleHRDcmVhdGVkIiwiY29udGV4dElkIiwiZ2V0SWQiLCJnZXQiLCJmb3JFYWNoIiwiZWwiLCJub2RlSWQiLCJjcmVhdGVOb2RlIiwiYWRkQ2hpbGRJbkNvbnRleHQiLCJTUElOQUxfUkVMQVRJT05fUFRSX0xTVF9UWVBFIiwiZ2V0QWxsVmlzaXRzIiwiUHJvbWlzZSIsInJlc29sdmUiLCJnZXRDaGlsZHJlbiIsImFkZFRhc2tPbkdyb3VwIiwiZ3JvdXBJZCIsInRhc2tOYW1lIiwicGVyaW9kaWNpdHlOdW1iZXIiLCJwZXJpb2RpY2l0eU1lc3VyZSIsInZpc2l0SWQiLCJpbnRlcnZlbnRpb25OdW1iZXIiLCJpbnRlcnZlbnRpb25NZXN1cmUiLCJkZXNjcmlwdGlvbiIsInZpc2l0TmFtZSIsImdldEluZm8iLCJjaGlsZHJlbiIsImFyZ05vZGVJZCIsImxlbmd0aCIsImFkZENoaWxkIiwibm9kZSIsImdldFB0clZhbHVlIiwibHN0IiwiX3ByZXBhcmVOb2RlIiwicmVhbE5vZGUiLCJnZXRSZWFsTm9kZSIsInB1c2giLCJpbmZvIiwicHRyTmFtZSIsImlkIiwiYWRkX2F0dHIiLCJQdHIiLCJMc3QiLCJsb2FkIiwidmFsdWUiLCJnZXRHcm91cFRhc2tzIiwidmlzaXR5VHlwZSIsInJlcyIsInRhc2siLCJWaXNpdE1vZGVsIiwicGVyaW9kaWNpdHkiLCJudW1iZXIiLCJtZXN1cmUiLCJpbnRlcnZlbnRpb24iLCJ2aXNpdFR5cGUiLCJzdGF0ZU5vZGVJZCIsInNwaW5hbFZpc2l0U2VydmljZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUE7O0FBS0E7O0FBSUE7Ozs7QUFDQTs7QUFJQTs7OztBQUlBO0FBQ0E7O0FBRUEsTUFBTUEsa0JBQU4sQ0FBeUI7QUFDdkJDLGdCQUFjO0FBQ1osU0FBS0Msa0JBQUwsR0FBMEIsZ0JBQTFCO0FBQ0EsU0FBS0MsWUFBTCxHQUFvQixlQUFwQjs7QUFFQSxTQUFLQyxVQUFMLEdBQWtCLE9BQWxCOztBQUVBLFNBQUtDLGlCQUFMLEdBQXlCLG1CQUF6QjtBQUNBLFNBQUtDLGdCQUFMLEdBQXdCLGtCQUF4QjtBQUNBLFNBQUtDLGNBQUwsR0FBc0IsZ0JBQXRCO0FBQ0EsU0FBS0MsZ0JBQUwsR0FBd0Isa0JBQXhCOztBQUVBLFNBQUtDLE1BQUwsR0FBY0MsT0FBT0MsTUFBUCxDQUFjLENBQUM7QUFDekJDLFlBQU0sS0FBS1AsaUJBRGM7QUFFekJRLFlBQU07QUFGbUIsS0FBRCxFQUkxQjtBQUNFRCxZQUFNLEtBQUtOLGdCQURiO0FBRUVPLFlBQU07QUFGUixLQUowQixFQVExQjtBQUNFRCxZQUFNLEtBQUtMLGNBRGI7QUFFRU0sWUFBTTtBQUZSLEtBUjBCLEVBWTFCO0FBQ0VELFlBQU0sS0FBS0osZ0JBRGI7QUFFRUssWUFBTTtBQUZSLEtBWjBCLENBQWQsQ0FBZDs7QUFrQkE7QUFDQSxTQUFLQyx5QkFBTCxHQUFpQyxVQUFqQztBQUNBLFNBQUtDLGFBQUwsR0FBcUIsU0FBckI7O0FBRUEsU0FBS0Msc0JBQUwsR0FBOEIsY0FBOUI7QUFDQSxTQUFLQyxhQUFMLEdBQXFCLFVBQXJCOztBQUVB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Y2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBTUElOQUxfUkVMQVRJT05fUFRSX0xTVF9UWVBFLFxuICBTcGluYWxHcmFwaFNlcnZpY2Vcbn0gZnJvbSBcInNwaW5hbC1lbnYtdmlld2VyLWdyYXBoLXNlcnZpY2VcIjtcblxuaW1wb3J0IHtcbiAgRVFVSVBNRU5UU19UT19FTEVNRU5UX1JFTEFUSU9OLFxuICBFUVVJUE1FTlRTX0dST1VQXG59IGZyb20gXCJzcGluYWwtZW52LXZpZXdlci1yb29tLW1hbmFnZXIvanMvc2VydmljZVwiO1xuaW1wb3J0IFZpc2l0TW9kZWwgZnJvbSBcIi4vdmlzaXQubW9kZWxcIjtcbmltcG9ydCB7XG4gIFB0cixcbiAgTHN0XG59IGZyb20gXCJzcGluYWwtY29yZS1jb25uZWN0b3Jqc190eXBlXCI7XG5pbXBvcnQge1xuICBNb2RlbFxufSBmcm9tIFwidnVlLXByb3BlcnR5LWRlY29yYXRvclwiO1xuXG4vLyBpbXBvcnQgT3BlcmF0aW9uTW9kZWwgZnJvbSBcIi4vb3BlcmF0aW9uTW9kZWxcIjtcbi8vIGltcG9ydCBWaXNpdE1vZGVsIGZyb20gXCIuL3Zpc2l0TW9kZWxcIjtcblxuY2xhc3MgU3BpbmFsVmlzaXRTZXJ2aWNlIHtcbiAgY29uc3RydWN0b3IoKSB7XG4gICAgdGhpcy5WSVNJVF9DT05URVhUX05BTUUgPSBcIi52aXNpdF9jb250ZXh0XCI7XG4gICAgdGhpcy5DT05URVhUX1RZUEUgPSBcInZpc2l0X2NvbnRleHRcIjtcblxuICAgIHRoaXMuVklTSVRfVFlQRSA9IFwidmlzaXRcIjtcblxuICAgIHRoaXMuTUFJTlRFTkFOQ0VfVklTSVQgPSBcIk1BSU5URU5BTkNFX1ZJU0lUXCI7XG4gICAgdGhpcy5SRUdVTEFUT1JZX1ZJU0lUID0gXCJSRUdVTEFUT1JZX1ZJU0lUXCI7XG4gICAgdGhpcy5TRUNVUklUWV9WSVNJVCA9IFwiU0VDVVJJVFlfVklTSVRcIjtcbiAgICB0aGlzLkRJQUdOT1NUSUNfVklTSVQgPSBcIkRJQUdOT1NUSUNfVklTSVRcIjtcblxuICAgIHRoaXMuVklTSVRTID0gT2JqZWN0LmZyZWV6ZShbe1xuICAgICAgICB0eXBlOiB0aGlzLk1BSU5URU5BTkNFX1ZJU0lULFxuICAgICAgICBuYW1lOiBcIk1haW50ZW5hY2UgdmlzaXRcIlxuICAgICAgfSxcbiAgICAgIHtcbiAgICAgICAgdHlwZTogdGhpcy5SRUdVTEFUT1JZX1ZJU0lULFxuICAgICAgICBuYW1lOiBcIlJlZ3VsYXRvcnkgdmlzaXRcIlxuICAgICAgfSxcbiAgICAgIHtcbiAgICAgICAgdHlwZTogdGhpcy5TRUNVUklUWV9WSVNJVCxcbiAgICAgICAgbmFtZTogXCJTZWN1cml0eSBWaXNpdFwiXG4gICAgICB9LFxuICAgICAge1xuICAgICAgICB0eXBlOiB0aGlzLkRJQUdOT1NUSUNfVklTSVQsXG4gICAgICAgIG5hbWU6IFwiRGlhZ25vc3RpYyB2aXNpdFwiXG4gICAgICB9XG4gICAgXSk7XG5cbiAgICAvL1JFTEFUSU9OU1xuICAgIHRoaXMuQ09OVEVYVF9UT19WSVNJVF9SRUxBVElPTiA9IFwiaGFzVmlzaXRcIjtcbiAgICB0aGlzLkdST1VQX1RPX1RBU0sgPSBcImhhc1Rhc2tcIjtcblxuICAgIHRoaXMuVklTSVRfVE9fVEFTS19SRUxBVElPTiA9IFwiaGFzVmlzaXRUYXNrXCI7XG4gICAgdGhpcy5UQVNLX1RPX1NUQVRFID0gXCJoYXNTdGF0ZVwiO1xuXG4gICAgdGhpcy5faW5pdCgpO1xuICB9XG5cbiAgX2luaXQoKSB7XG4gICAgU3BpbmFsR3JhcGhTZXJ2aWNlLndhaXRGb3JJbml0aWFsaXphdGlvbigpLnRoZW4oKCkgPT4ge1xuICAgICAgbGV0IGNvbnRleHQgPSBTcGluYWxHcmFwaFNlcnZpY2UuZ2V0Q29udGV4dCh0aGlzXG4gICAgICAgIC5WSVNJVF9DT05URVhUX05BTUUpO1xuXG4gICAgICBpZiAodHlwZW9mIGNvbnRleHQgIT09IFwidW5kZWZpbmVkXCIpIHJldHVybjtcblxuICAgICAgU3BpbmFsR3JhcGhTZXJ2aWNlLmFkZENvbnRleHQoXG4gICAgICAgIHRoaXMuVklTSVRfQ09OVEVYVF9OQU1FLFxuICAgICAgICB0aGlzLkNPTlRFWFRfVFlQRSxcbiAgICAgICAgbmV3IE1vZGVsKHtcbiAgICAgICAgICBuYW1lOiB0aGlzLlZJU0lUX0NPTlRFWFRfTkFNRVxuICAgICAgICB9KVxuICAgICAgKS50aGVuKGNvbnRleHRDcmVhdGVkID0+IHtcbiAgICAgICAgbGV0IGNvbnRleHRJZCA9IGNvbnRleHRDcmVhdGVkLmdldElkKCkuZ2V0KCk7XG5cbiAgICAgICAgdGhpcy5WSVNJVFMuZm9yRWFjaChlbCA9PiB7XG4gICAgICAgICAgbGV0IG5vZGVJZCA9IFNwaW5hbEdyYXBoU2VydmljZS5jcmVhdGVOb2RlKHtcbiAgICAgICAgICAgICAgbmFtZTogZWwubmFtZSxcbiAgICAgICAgICAgICAgdHlwZTogZWwudHlwZVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIG5ldyBNb2RlbCh7XG4gICAgICAgICAgICAgIG5hbWU6IGVsXG4gICAgICAgICAgICB9KVxuICAgICAgICAgICk7XG5cbiAgICAgICAgICBTcGluYWxHcmFwaFNlcnZpY2UuYWRkQ2hpbGRJbkNvbnRleHQoXG4gICAgICAgICAgICBjb250ZXh0SWQsXG4gICAgICAgICAgICBub2RlSWQsXG4gICAgICAgICAgICBjb250ZXh0SWQsXG4gICAgICAgICAgICB0aGlzLkNPTlRFWFRfVE9fVklTSVRfUkVMQVRJT04sXG4gICAgICAgICAgICBTUElOQUxfUkVMQVRJT05fUFRSX0xTVF9UWVBFXG4gICAgICAgICAgKTtcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG5cbiAgZ2V0QWxsVmlzaXRzKCkge1xuICAgIGxldCBjb250ZXh0ID0gU3BpbmFsR3JhcGhTZXJ2aWNlLmdldENvbnRleHQodGhpcy5WSVNJVF9DT05URVhUX05BTUUpO1xuXG4gICAgaWYgKHR5cGVvZiBjb250ZXh0ID09PSBcInVuZGVmaW5lZFwiKSByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKFtdKTtcblxuICAgIGxldCBjb250ZXh0SWQgPSBjb250ZXh0LmdldElkKCkuZ2V0KCk7XG5cbiAgICByZXR1cm4gU3BpbmFsR3JhcGhTZXJ2aWNlLmdldENoaWxkcmVuKGNvbnRleHRJZCwgW1xuICAgICAgdGhpcy5DT05URVhUX1RPX1ZJU0lUX1JFTEFUSU9OXG4gICAgXSk7XG4gIH1cblxuICBhZGRUYXNrT25Hcm91cChcbiAgICBncm91cElkLFxuICAgIHRhc2tOYW1lLFxuICAgIHBlcmlvZGljaXR5TnVtYmVyLFxuICAgIHBlcmlvZGljaXR5TWVzdXJlLFxuICAgIHZpc2l0SWQsXG4gICAgaW50ZXJ2ZW50aW9uTnVtYmVyLFxuICAgIGludGVydmVudGlvbk1lc3VyZSxcbiAgICBkZXNjcmlwdGlvblxuICApIHtcblxuICAgIGxldCB2aXNpdE5hbWUgPSBTcGluYWxHcmFwaFNlcnZpY2UuZ2V0SW5mbyh2aXNpdElkKS50eXBlLmdldCgpO1xuXG4gICAgcmV0dXJuIFNwaW5hbEdyYXBoU2VydmljZS5nZXRDaGlsZHJlbihncm91cElkLCBbdGhpcy5HUk9VUF9UT19UQVNLXSkudGhlbihcbiAgICAgIGNoaWxkcmVuID0+IHtcblxuICAgICAgICBsZXQgYXJnTm9kZUlkO1xuICAgICAgICBpZiAoY2hpbGRyZW4ubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgYXJnTm9kZUlkID0gU3BpbmFsR3JhcGhTZXJ2aWNlLmNyZWF0ZU5vZGUoe1xuICAgICAgICAgICAgbmFtZTogXCJtYWludGVuYW5jZVwiXG4gICAgICAgICAgfSk7XG5cbiAgICAgICAgICBTcGluYWxHcmFwaFNlcnZpY2UuYWRkQ2hpbGQoXG4gICAgICAgICAgICBncm91cElkLFxuICAgICAgICAgICAgYXJnTm9kZUlkLFxuICAgICAgICAgICAgdGhpcy5HUk9VUF9UT19UQVNLLFxuICAgICAgICAgICAgU1BJTkFMX1JFTEFUSU9OX1BUUl9MU1RfVFlQRVxuICAgICAgICAgICk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgbm9kZSA9XG4gICAgICAgICAgdHlwZW9mIGFyZ05vZGVJZCAhPT0gXCJ1bmRlZmluZWRcIiA/XG4gICAgICAgICAgU3BpbmFsR3JhcGhTZXJ2aWNlLmdldEluZm8oYXJnTm9kZUlkKSA6XG4gICAgICAgICAgY2hpbGRyZW5bMF07XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0UHRyVmFsdWUobm9kZSwgdmlzaXROYW1lKS50aGVuKGxzdCA9PiB7XG5cbiAgICAgICAgICBsZXQgbm9kZUlkID0gdGhpcy5fcHJlcGFyZU5vZGUoZ3JvdXBJZCwgdGFza05hbWUsXG4gICAgICAgICAgICBwZXJpb2RpY2l0eU51bWJlcixcbiAgICAgICAgICAgIHBlcmlvZGljaXR5TWVzdXJlLFxuICAgICAgICAgICAgdmlzaXRJZCxcbiAgICAgICAgICAgIHZpc2l0TmFtZSxcbiAgICAgICAgICAgIGludGVydmVudGlvbk51bWJlcixcbiAgICAgICAgICAgIGludGVydmVudGlvbk1lc3VyZSxcbiAgICAgICAgICAgIGRlc2NyaXB0aW9uKTtcblxuICAgICAgICAgIFNwaW5hbEdyYXBoU2VydmljZS5hZGRDaGlsZCh2aXNpdElkLCBub2RlSWQsIHRoaXNcbiAgICAgICAgICAgIC5WSVNJVF9UT19UQVNLX1JFTEFUSU9OLCBTUElOQUxfUkVMQVRJT05fUFRSX0xTVF9UWVBFKTtcblxuICAgICAgICAgIGxldCByZWFsTm9kZSA9IFNwaW5hbEdyYXBoU2VydmljZS5nZXRSZWFsTm9kZShub2RlSWQpO1xuXG4gICAgICAgICAgbHN0LnB1c2gocmVhbE5vZGUpO1xuXG4gICAgICAgICAgcmV0dXJuIHJlYWxOb2RlLmluZm87XG5cbiAgICAgICAgfSlcbiAgICAgIH1cbiAgICApO1xuXG4gICAgLy8gbGV0IHRhc2sgPSBuZXcgVmlzaXRNb2RlbCh0YXNrTmFtZSwgYmVnaW5EYXRlLCBwZXJpb2RpY2l0eU51bWJlcixcbiAgICAvLyAgIHBlcmlvZGljaXR5TWVzdXJlLFxuICAgIC8vICAgdmlzaXRJZCwgdmlzaXROYW1lKTtcblxuICAgIC8vIGxldCBub2RlSWQgPSBTcGluYWxHcmFwaFNlcnZpY2UuY3JlYXRlTm9kZSh7XG4gICAgLy8gICBuYW1lOiB0YXNrTmFtZSxcbiAgICAvLyAgIHR5cGU6IFwidGFza1wiLFxuICAgIC8vICAgdmlzaXRJZDogdmlzaXRJZFxuICAgIC8vIH0sIHRhc2spO1xuXG4gICAgLy8gLy8gcmV0dXJuIFNwaW5hbEdyYXBoU2VydmljZS5hZGRDaGlsZChncm91cElkLCBub2RlSWQsIHRoaXMuR1JPVVBfVE9fVEFTSyxcbiAgICAvLyAvLyAgIFNQSU5BTF9SRUxBVElPTl9QVFJfTFNUX1RZUEUpLnRoZW4oZWwgPT4ge1xuICAgIC8vIC8vICAgaWYgKGVsKSB7XG4gICAgLy8gLy8gICAgIHRoaXMuYWRkT3BlcmF0aW9ucyhncm91cElkLCBub2RlSWQsIGJlZ2luRGF0ZSk7XG4gICAgLy8gLy8gICAgIHJldHVybiB0YXNrO1xuICAgIC8vIC8vICAgfVxuICAgIC8vIC8vIH0pXG4gIH1cblxuICBnZXRQdHJWYWx1ZShub2RlLCBwdHJOYW1lKSB7XG4gICAgbGV0IHJlYWxOb2RlID0gU3BpbmFsR3JhcGhTZXJ2aWNlLmdldFJlYWxOb2RlKG5vZGUuaWQuZ2V0KCkpO1xuXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XG4gICAgICBpZiAoIXJlYWxOb2RlLmluZm9bcHRyTmFtZV0pIHtcbiAgICAgICAgcmVhbE5vZGUuaW5mby5hZGRfYXR0cihwdHJOYW1lLCBuZXcgUHRyKG5ldyBMc3QoKSkpO1xuICAgICAgfVxuXG4gICAgICByZWFsTm9kZS5pbmZvW3B0ck5hbWVdLmxvYWQoKHZhbHVlKSA9PiB7XG4gICAgICAgIHJldHVybiByZXNvbHZlKHZhbHVlKTtcbiAgICAgIH0pXG4gICAgfSlcblxuXG4gIH1cblxuICBnZXRHcm91cFRhc2tzKGdyb3VwSWQsIHZpc2l0eVR5cGUpIHtcbiAgICByZXR1cm4gU3BpbmFsR3JhcGhTZXJ2aWNlLmdldENoaWxkcmVuKGdyb3VwSWQsIFt0aGlzLkdST1VQX1RPX1RBU0tdKS50aGVuKFxuICAgICAgcmVzID0+IHtcbiAgICAgICAgbGV0IG5vZGVJZDtcbiAgICAgICAgaWYgKHJlcy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICBub2RlSWQgPSBTcGluYWxHcmFwaFNlcnZpY2UuY3JlYXRlTm9kZSh7XG4gICAgICAgICAgICBuYW1lOiBcIm1haW50ZW5hbmNlXCJcbiAgICAgICAgICB9KTtcblxuICAgICAgICAgIFNwaW5hbEdyYXBoU2VydmljZS5hZGRDaGlsZChcbiAgICAgICAgICAgIGdyb3VwSWQsXG4gICAgICAgICAgICBub2RlSWQsXG4gICAgICAgICAgICB0aGlzLkdST1VQX1RPX1RBU0ssXG4gICAgICAgICAgICBTUElOQUxfUkVMQVRJT05fUFRSX0xTVF9UWVBFXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBub2RlID1cbiAgICAgICAgICB0eXBlb2Ygbm9kZUlkICE9PSBcInVuZGVmaW5lZFwiID9cbiAgICAgICAgICBTcGluYWxHcmFwaFNlcnZpY2UuZ2V0SW5mbyhub2RlSWQpIDpcbiAgICAgICAgICByZXNbMF07XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0UHRyVmFsdWUobm9kZSwgdmlzaXR5VHlwZSk7XG4gICAgICB9KTtcblxuICB9XG5cblxuXG4gIF9wcmVwYXJlTm9kZShncm91cElkLCB0YXNrTmFtZSxcbiAgICBwZXJpb2RpY2l0eU51bWJlcixcbiAgICBwZXJpb2RpY2l0eU1lc3VyZSxcbiAgICB2aXNpdElkLFxuICAgIHZpc2l0TmFtZSxcbiAgICBpbnRlcnZlbnRpb25OdW1iZXIsXG4gICAgaW50ZXJ2ZW50aW9uTWVzdXJlLFxuICAgIGRlc2NyaXB0aW9uKSB7XG5cbiAgICBsZXQgdGFzayA9IG5ldyBWaXNpdE1vZGVsKHRhc2tOYW1lLCBwZXJpb2RpY2l0eU51bWJlcixcbiAgICAgIHBlcmlvZGljaXR5TWVzdXJlLCB2aXNpdElkLCB2aXNpdE5hbWUsIGludGVydmVudGlvbk51bWJlcixcbiAgICAgIGludGVydmVudGlvbk1lc3VyZSwgZGVzY3JpcHRpb24pO1xuXG4gICAgbGV0IG5vZGVJZCA9IFNwaW5hbEdyYXBoU2VydmljZS5jcmVhdGVOb2RlKHtcbiAgICAgIGdyb3VwSWQ6IGdyb3VwSWQsXG4gICAgICBuYW1lOiB0YXNrTmFtZSxcbiAgICAgIHBlcmlvZGljaXR5OiB7XG4gICAgICAgIG51bWJlcjogdGFzay5wZXJpb2RpY2l0eS5udW1iZXIuZ2V0KCksXG4gICAgICAgIG1lc3VyZTogdGFzay5wZXJpb2RpY2l0eS5tZXN1cmUuZ2V0KClcbiAgICAgIH0sXG4gICAgICBpbnRlcnZlbnRpb246IHtcbiAgICAgICAgbnVtYmVyOiB0YXNrLmludGVydmVudGlvbi5udW1iZXIuZ2V0KCksXG4gICAgICAgIG1lc3VyZTogdGFzay5pbnRlcnZlbnRpb24ubWVzdXJlLmdldCgpXG4gICAgICB9LFxuICAgICAgdmlzaXRJZDogdmlzaXRJZCxcbiAgICAgIHZpc2l0VHlwZTogdmlzaXROYW1lLFxuICAgICAgZGVzY3JpcHRpb246IGRlc2NyaXB0aW9uXG5cbiAgICB9LCB0YXNrKTtcblxuXG4gICAgbGV0IHN0YXRlTm9kZUlkID0gU3BpbmFsR3JhcGhTZXJ2aWNlLmNyZWF0ZU5vZGUoe1xuICAgICAgbmFtZTogXCJzdGF0ZVwiXG4gICAgfSwgbmV3IE1vZGVsKHtcbiAgICAgIG5hbWU6IFwic3RhdGVcIlxuICAgIH0pKTtcblxuICAgIFNwaW5hbEdyYXBoU2VydmljZS5hZGRDaGlsZChub2RlSWQsIHN0YXRlTm9kZUlkLCB0aGlzLlRBU0tfVE9fU1RBVEUsXG4gICAgICBTUElOQUxfUkVMQVRJT05fUFRSX0xTVF9UWVBFKTtcblxuICAgIGxldCByZWFsTm9kZSA9IFNwaW5hbEdyYXBoU2VydmljZS5nZXRSZWFsTm9kZShzdGF0ZU5vZGVJZCk7XG5cbiAgICBbXCJQcm9jZXNzaW5nXCIsIFwiVmFsaWRhdGVkXCIsIFwiSW52YWxpZGF0ZWRcIl0uZm9yRWFjaCgoZWwpID0+IHtcbiAgICAgIHJlYWxOb2RlLmluZm8uYWRkX2F0dHIoW2VsXSwgbmV3IFB0cihuZXcgTHN0KCkpKTtcbiAgICB9KVxuXG5cbiAgICByZXR1cm4gbm9kZUlkO1xuXG4gIH1cblxuXG5cbiAgLy8gYWRkT3BlcmF0aW9ucyhncm91cElkLCB0YXNrSWQsIGRhdGUpIHtcbiAgLy8gICBQcm9taXNlLmFsbChbU3BpbmFsR3JhcGhTZXJ2aWNlLmdldEluZm8odGFza0lkKS5lbGVtZW50LmxvYWQoKSxcbiAgLy8gICAgIFNwaW5hbEdyYXBoU2VydmljZS5nZXRDaGlsZHJlbihcbiAgLy8gICAgICAgZ3JvdXBJZCwgW0VRVUlQTUVOVFNfVE9fRUxFTUVOVF9SRUxBVElPTl0pXG4gIC8vICAgXSkudGhlbihhc3luYyB2YWx1ZXMgPT4ge1xuICAvLyAgICAgbGV0IHZpc2l0ID0gbmV3IFZpc2l0TW9kZWwoZGF0ZSk7XG5cbiAgLy8gICAgIGxldCB0YXNrT3BlcmF0aW9ucyA9IGF3YWl0IHZhbHVlc1swXS5vcGVyYXRpb25zLmRhdGEubW9kZWw7XG5cbiAgLy8gICAgIHZhbHVlc1sxXS5mb3JFYWNoKGVsID0+IHtcbiAgLy8gICAgICAgdmlzaXQuYmltcy5wdXNoKG5ldyBPcGVyYXRpb25Nb2RlbChlbC5uYW1lLmdldCgpLCBlbC5kYmlkXG4gIC8vICAgICAgICAgLmdldCgpKSlcbiAgLy8gICAgIH0pO1xuXG4gIC8vICAgICB0YXNrT3BlcmF0aW9ucy5wdXNoKHZpc2l0KTtcblxuICAvLyAgIH0pXG4gIC8vIH1cblxuICAvLyBnZXRHcm91cE9wZXJhdGlvbihub2RlSWQpIHtcbiAgLy8gICBsZXQgbm9kZUluZm8gPSBTcGluYWxHcmFwaFNlcnZpY2UuZ2V0SW5mbyhub2RlSWQpO1xuXG4gIC8vICAgaWYgKG5vZGVJbmZvLnR5cGUuZ2V0KCkgPT09IEVRVUlQTUVOVFNfR1JPVVApIHtcbiAgLy8gICAgIHJldHVybiB0aGlzLmdldEdyb3VwVGFza3Mobm9kZUlkKS50aGVuKHRhc2tzID0+IHtcbiAgLy8gICAgICAgbGV0IHByb21pc2VzID0gdGFza3MubWFwKGFzeW5jIGVsID0+IHtcbiAgLy8gICAgICAgICByZXR1cm4ge1xuICAvLyAgICAgICAgICAgdGFza0lkOiBlbC5pZC5nZXQoKSxcbiAgLy8gICAgICAgICAgIHRhc2tOYW1lOiBlbC5uYW1lLmdldCgpLFxuICAvLyAgICAgICAgICAgb3BlcmF0aW9uczogKGF3YWl0IHRoaXMuZ2V0VGFza09wZXJhdGlvbnMoZWwuaWQuZ2V0KCkpKVxuICAvLyAgICAgICAgICAgICAuZ2V0KClcbiAgLy8gICAgICAgICB9O1xuICAvLyAgICAgICB9KVxuXG4gIC8vICAgICAgIHJldHVybiBQcm9taXNlLmFsbChwcm9taXNlcyk7XG4gIC8vICAgICB9KVxuICAvLyAgIH0gZWxzZSB7XG4gIC8vICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKFtdKTtcbiAgLy8gICB9XG5cbiAgLy8gfVxuXG4gIC8vIGdldFRhc2tPcGVyYXRpb25zKHRhc2tJZCwgb3BlcmF0aW9uRGF0ZSkge1xuICAvLyAgIGxldCBpbmZvID0gU3BpbmFsR3JhcGhTZXJ2aWNlLmdldEluZm8odGFza0lkKTtcbiAgLy8gICByZXR1cm4gaW5mby5lbGVtZW50LmxvYWQoKS50aGVuKGVsZW1lbnQgPT4ge1xuICAvLyAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XG4gIC8vICAgICAgIGVsZW1lbnQub3BlcmF0aW9ucy5sb2FkKChvcGVyYXRpb25zKSA9PiB7XG4gIC8vICAgICAgICAgaWYgKHR5cGVvZiBvcGVyYXRpb25EYXRlID09PSBcInVuZGVmaW5lZFwiKSB7XG4gIC8vICAgICAgICAgICByZXNvbHZlKG9wZXJhdGlvbnMpO1xuICAvLyAgICAgICAgIH0gZWxzZSB7XG4gIC8vICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG9wZXJhdGlvbnMubGVuZ3RoOyBpKyspIHtcbiAgLy8gICAgICAgICAgICAgY29uc3Qgb3BlcmF0aW9uID0gb3BlcmF0aW9uc1tpXTtcbiAgLy8gICAgICAgICAgICAgaWYgKG9wZXJhdGlvbi5kYXRlLmdldCgpLnRvU3RyaW5nKCkgPT09XG4gIC8vICAgICAgICAgICAgICAgb3BlcmF0aW9uRGF0ZVxuICAvLyAgICAgICAgICAgICAgIC50b1N0cmluZygpKSB7XG4gIC8vICAgICAgICAgICAgICAgcmVzb2x2ZShvcGVyYXRpb25baV0pO1xuICAvLyAgICAgICAgICAgICB9XG4gIC8vICAgICAgICAgICB9XG4gIC8vICAgICAgICAgfVxuICAvLyAgICAgICB9KVxuICAvLyAgICAgfSlcbiAgLy8gICB9KVxuICAvLyB9XG59XG5cbmxldCBzcGluYWxWaXNpdFNlcnZpY2UgPSBuZXcgU3BpbmFsVmlzaXRTZXJ2aWNlKCk7XG5cbmV4cG9ydCBkZWZhdWx0IHNwaW5hbFZpc2l0U2VydmljZTsiXX0=