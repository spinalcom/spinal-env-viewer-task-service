"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _spinalEnvViewerGraphService = require("spinal-env-viewer-graph-service");

var _service = require("spinal-env-viewer-room-manager/js/service");

var _visitModel = require("./models/visit.model.js");

var _visitModel2 = _interopRequireDefault(_visitModel);

var _eventModel = require("./models/event.model.js");

var _eventModel2 = _interopRequireDefault(_eventModel);

var _taskModel = require("./models/task.model.js");

var _taskModel2 = _interopRequireDefault(_taskModel);

var _spinalCoreConnectorjs_type = require("spinal-core-connectorjs_type");

var _moment = require("moment");

var _moment2 = _interopRequireDefault(_moment);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _asyncToGenerator(fn) { return function () { var gen = fn.apply(this, arguments); return new Promise(function (resolve, reject) { function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { return Promise.resolve(value).then(function (value) { step("next", value); }, function (err) { step("throw", err); }); } } return step("next"); }); }; }

// import OperationModel from "./operationModel";
// import VisitModel from "./visitModel";

class SpinalVisitService {
  constructor() {
    this.VISIT_CONTEXT_NAME = ".visit_context";
    this.CONTEXT_TYPE = "visit_context";

    this.VISIT_TYPE = "visit";

    this.MAINTENANCE_VISIT = "MAINTENANCE_VISIT";
    this.REGULATORY_VISIT = "REGULATORY_VISIT";
    this.SECURITY_VISIT = "SECURITY_VISIT";
    this.DIAGNOSTIC_VISIT = "DIAGNOSTIC_VISIT";

    this.EVENT_STATES = Object.freeze({
      declared: "déclaré",
      processing: "encours",
      done: "éffectué"
    });

    this.VISITS = Object.freeze([{
      type: this.MAINTENANCE_VISIT,
      name: "Maintenace visit"
    }, {
      type: this.REGULATORY_VISIT,
      name: "Regulatory visit"
    }, {
      type: this.SECURITY_VISIT,
      name: "Security Visit"
    }, {
      type: this.DIAGNOSTIC_VISIT,
      name: "Diagnostic visit"
    }]);

    //RELATIONS
    // this.CONTEXT_TO_VISIT_RELATION = "hasVisit";
    this.GROUP_TO_TASK = "hasTask";

    this.VISIT_TO_GROUP_RELATION = "visitHasGroup";
    this.GROUP_TO_EVENT_STATE_RELATION = "hasEventState";
    this.EVENT_STATE_TO_EVENT_RELATION = "hasEvent";
    this.EVENT_TO_TASK_RELATION = "hasTask";
    // this.TASK_TO_STATE = "hasState";

    // this._init();
  }

  _init() {
    _spinalEnvViewerGraphService.SpinalGraphService.waitForInitialization().then(() => {
      let context = _spinalEnvViewerGraphService.SpinalGraphService.getContext(this.VISIT_CONTEXT_NAME);

      if (typeof context !== "undefined") return;

      _spinalEnvViewerGraphService.SpinalGraphService.addContext(this.VISIT_CONTEXT_NAME, this.CONTEXT_TYPE, new _spinalCoreConnectorjs_type.Model({
        name: this.VISIT_CONTEXT_NAME
      })).then(contextCreated => {
        let contextId = contextCreated.getId().get();

        this.VISITS.forEach(el => {
          let nodeId = _spinalEnvViewerGraphService.SpinalGraphService.createNode({
            name: el.name,
            type: el.type
          }, new _spinalCoreConnectorjs_type.Model({
            name: el
          }));

          _spinalEnvViewerGraphService.SpinalGraphService.addChildInContext(contextId, nodeId, contextId, this.CONTEXT_TO_VISIT_RELATION, _spinalEnvViewerGraphService.SPINAL_RELATION_PTR_LST_TYPE);
        });
      });
    });
  }

  getAllVisits() {
    return this.VISITS;
  }

  addTaskOnGroup(groupId, taskName, periodicityNumber, periodicityMesure, visitName, interventionNumber, interventionMesure, description) {

    // let visitName = SpinalGraphService.getInfo(visitId).type.get();

    return _spinalEnvViewerGraphService.SpinalGraphService.getChildren(groupId, [this.GROUP_TO_TASK]).then(children => {

      let argNodeId;
      if (children.length === 0) {
        argNodeId = _spinalEnvViewerGraphService.SpinalGraphService.createNode({
          name: "maintenance"
        });

        _spinalEnvViewerGraphService.SpinalGraphService.addChild(groupId, argNodeId, this.GROUP_TO_TASK, _spinalEnvViewerGraphService.SPINAL_RELATION_PTR_LST_TYPE);
      }

      let node = typeof argNodeId !== "undefined" ? _spinalEnvViewerGraphService.SpinalGraphService.getInfo(argNodeId) : children[0];

      return this.getPtrValue(node, visitName).then(lst => {

        // let nodeId = this._prepareNode(groupId, taskName,
        //   periodicityNumber,
        //   periodicityMesure,
        //   visitId,
        //   visitName,
        //   interventionNumber,
        //   interventionMesure,
        //   description);

        // SpinalGraphService.addChild(visitId, nodeId, this
        //   .VISIT_TO_TASK_RELATION, SPINAL_RELATION_PTR_LST_TYPE);


        let task = new _visitModel2.default(taskName, periodicityNumber, periodicityMesure, visitName, interventionNumber, interventionMesure, description);

        let nodeId = _spinalEnvViewerGraphService.SpinalGraphService.createNode({
          groupId: groupId,
          name: taskName,
          periodicity: {
            number: task.periodicity.number.get(),
            mesure: task.periodicity.mesure.get()
          },
          intervention: {
            number: task.intervention.number.get(),
            mesure: task.intervention.mesure.get()
          },
          visitType: visitName,
          description: description

        }, task);

        let realNode = _spinalEnvViewerGraphService.SpinalGraphService.getRealNode(nodeId);

        lst.push(realNode);

        return realNode.info;
      });
    });

    // let task = new VisitModel(taskName, beginDate, periodicityNumber,
    //   periodicityMesure,
    //   visitId, visitName);

    // let nodeId = SpinalGraphService.createNode({
    //   name: taskName,
    //   type: "task",
    //   visitId: visitId
    // }, task);

    // // return SpinalGraphService.addChild(groupId, nodeId, this.GROUP_TO_TASK,
    // //   SPINAL_RELATION_PTR_LST_TYPE).then(el => {
    // //   if (el) {
    // //     this.addOperations(groupId, nodeId, beginDate);
    // //     return task;
    // //   }
    // // })
  }

  getPtrValue(node, ptrName) {
    let realNode = _spinalEnvViewerGraphService.SpinalGraphService.getRealNode(node.id.get());

    return new Promise(resolve => {
      if (!realNode.info[ptrName]) {
        realNode.info.add_attr(ptrName, {
          tasks: new _spinalCoreConnectorjs_type.Ptr(new _spinalCoreConnectorjs_type.Lst())
        });
      }

      realNode.info[ptrName].tasks.load(value => {
        return resolve(value);
      });
    });
  }

  getGroupTasks(groupId, visityType) {
    return _spinalEnvViewerGraphService.SpinalGraphService.getChildren(groupId, [this.GROUP_TO_TASK]).then(res => {
      let nodeId;
      if (res.length === 0) {
        nodeId = _spinalEnvViewerGraphService.SpinalGraphService.createNode({
          name: "maintenance"
        });

        _spinalEnvViewerGraphService.SpinalGraphService.addChild(groupId, nodeId, this.GROUP_TO_TASK, _spinalEnvViewerGraphService.SPINAL_RELATION_PTR_LST_TYPE);
      }

      let node = typeof nodeId !== "undefined" ? _spinalEnvViewerGraphService.SpinalGraphService.getInfo(nodeId) : res[0];

      return this.getPtrValue(node, visityType);
    });
  }

  generateEvent(visitType, groupId, beginDate, endDate, eventsData) {

    return this.createVisitContext(visitType).then(el => {

      return this.linkGroupToVistContext(el.id.get(), groupId).then(res => {

        if (res) {
          this.getEventStateNode(groupId, this.EVENT_STATES.declared).then(stateNode => {
            let id = stateNode.id.get();

            eventsData.forEach(eventInfo => {
              let eventsDate = this._getDate(beginDate, endDate, eventInfo.periodNumber, eventInfo.periodMesure);

              eventsDate.forEach(date => {
                this.addEvent(groupId, id, eventInfo.name, `${eventInfo.name}_${this._formatDate(date)}`, new Date(date).getTime());
              });
            });
          });
        }
      });
    }).catch(err => {
      console.log(err);
      return Promise.resolve(err);
    });
  }

  addEvent(groupId, stateId, taskName, name, date) {

    let state = _spinalEnvViewerGraphService.SpinalGraphService.getInfo(stateId).name.get();

    let event = new _eventModel2.default(name, date, state, groupId);

    let eventNodeId = _spinalEnvViewerGraphService.SpinalGraphService.createNode({
      name: name,
      date: date,
      state: state,
      groupId: groupId
    }, event);

    return _spinalEnvViewerGraphService.SpinalGraphService.addChild(stateId, eventNodeId, this.EVENT_STATE_TO_EVENT_RELATION, _spinalEnvViewerGraphService.SPINAL_RELATION_PTR_LST_TYPE).then(el => {
      if (el) return eventNodeId;
    }).then(eventId => {

      if (typeof eventId !== "undefined") {
        return _spinalEnvViewerGraphService.SpinalGraphService.getChildren(groupId, [_service.EQUIPMENTS_TO_ELEMENT_RELATION]).then(children => {

          return children.map(child => {
            let task = new _taskModel2.default(child.name.get(), child.dbid.get(), child.bimFileId.get(), taskName, 0);

            let taskId = _spinalEnvViewerGraphService.SpinalGraphService.createNode({
              name: child.name.get(),
              dbId: child.dbid.get(),
              bimFileId: child.bimFileId.get(),
              taskName: taskName,
              state: task.state.get()
            }, task);

            return _spinalEnvViewerGraphService.SpinalGraphService.addChild(eventId, taskId, this.EVENT_TO_TASK_RELATION, _spinalEnvViewerGraphService.SPINAL_RELATION_PTR_LST_TYPE);
          });
        });
      }
    });
  }

  createVisitContext(visitType) {

    let visit = this.VISITS.find(el => {
      return el.type === visitType;
    });

    if (typeof visit !== "undefined") {
      const contextName = `.${visit.name}`;

      let context = _spinalEnvViewerGraphService.SpinalGraphService.getContext(contextName);
      if (typeof context !== "undefined") return Promise.resolve(context.info);

      return _spinalEnvViewerGraphService.SpinalGraphService.addContext(contextName, visitType, new _spinalCoreConnectorjs_type.Model({
        name: this.VISIT_CONTEXT_NAME
      })).then(contextCreated => {
        return contextCreated.info;
      });
    } else {
      return Promise.reject("visitNotFound");
    }
  }

  linkGroupToVistContext(visitContextId, groupId) {
    var _this = this;

    return _spinalEnvViewerGraphService.SpinalGraphService.getChildren(visitContextId, [this.VISIT_TO_GROUP_RELATION]).then(children => {

      for (let i = 0; i < children.length; i++) {
        const child = children[i].id.get();
        if (child === groupId) return true;
      }
    }).then(el => {

      if (typeof el === "undefined") {

        return _spinalEnvViewerGraphService.SpinalGraphService.addChild(visitContextId, groupId, this.VISIT_TO_GROUP_RELATION, _spinalEnvViewerGraphService.SPINAL_RELATION_PTR_LST_TYPE).then((() => {
          var _ref = _asyncToGenerator(function* (res) {

            if (res) {
              yield _this.getEventStateNode(groupId, _this.EVENT_STATES.processing);
              yield _this.getEventStateNode(groupId, _this.EVENT_STATES.done);
            }

            return res;
          });

          return function (_x) {
            return _ref.apply(this, arguments);
          };
        })());
      } else {

        return el;
      }
    });
  }

  getEventStateNode(groupId, eventSate) {
    return _spinalEnvViewerGraphService.SpinalGraphService.getChildren(groupId, [this.GROUP_TO_EVENT_STATE_RELATION]).then(children => {

      for (let i = 0; i < children.length; i++) {
        const name = children[i].name.get();

        if (name === eventSate) {
          return children[i];
        }
      }
    }).then(el => {
      if (typeof el === "undefined") {
        let argNodeId = _spinalEnvViewerGraphService.SpinalGraphService.createNode({
          name: eventSate,
          state: eventSate,
          type: "EventState"
        });

        return _spinalEnvViewerGraphService.SpinalGraphService.addChild(groupId, argNodeId, this.GROUP_TO_EVENT_STATE_RELATION, _spinalEnvViewerGraphService.SPINAL_RELATION_PTR_LST_TYPE).then(res => {
          if (res) return _spinalEnvViewerGraphService.SpinalGraphService.getInfo(argNodeId);
        });
      } else {
        return el;
      }
    });
  }

  ////////////////////////////////////////////////////////////////////////
  //                            PRIVATES                                //
  ////////////////////////////////////////////////////////////////////////


  _getDate(beginDate, endDate, periodNumber, periodMesure) {

    let mesure = ['days', 'weeks', 'months', 'years'][periodMesure];

    let eventsDate = [];

    let date = (0, _moment2.default)(beginDate);
    let end = (0, _moment2.default)(endDate);

    while (end.diff(date) >= 0) {
      eventsDate.push(date.toDate());

      date = date.add(periodNumber, mesure);
    }

    return eventsDate;
  }

  _formatDate(argDate) {
    let date = new Date(argDate);

    return `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`;
  }

}

let spinalVisitService = new SpinalVisitService();

exports.default = spinalVisitService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJTcGluYWxWaXNpdFNlcnZpY2UiLCJjb25zdHJ1Y3RvciIsIlZJU0lUX0NPTlRFWFRfTkFNRSIsIkNPTlRFWFRfVFlQRSIsIlZJU0lUX1RZUEUiLCJNQUlOVEVOQU5DRV9WSVNJVCIsIlJFR1VMQVRPUllfVklTSVQiLCJTRUNVUklUWV9WSVNJVCIsIkRJQUdOT1NUSUNfVklTSVQiLCJFVkVOVF9TVEFURVMiLCJPYmplY3QiLCJmcmVlemUiLCJkZWNsYXJlZCIsInByb2Nlc3NpbmciLCJkb25lIiwiVklTSVRTIiwidHlwZSIsIm5hbWUiLCJHUk9VUF9UT19UQVNLIiwiVklTSVRfVE9fR1JPVVBfUkVMQVRJT04iLCJHUk9VUF9UT19FVkVOVF9TVEFURV9SRUxBVElPTiIsIkVWRU5UX1NUQVRFX1RPX0VWRU5UX1JFTEFUSU9OIiwiRVZFTlRfVE9fVEFTS19SRUxBVElPTiIsIl9pbml0IiwiU3BpbmFsR3JhcGhTZXJ2aWNlIiwid2FpdEZvckluaXRpYWxpemF0aW9uIiwidGhlbiIsImNvbnRleHQiLCJnZXRDb250ZXh0IiwiYWRkQ29udGV4dCIsIk1vZGVsIiwiY29udGV4dENyZWF0ZWQiLCJjb250ZXh0SWQiLCJnZXRJZCIsImdldCIsImZvckVhY2giLCJlbCIsIm5vZGVJZCIsImNyZWF0ZU5vZGUiLCJhZGRDaGlsZEluQ29udGV4dCIsIkNPTlRFWFRfVE9fVklTSVRfUkVMQVRJT04iLCJTUElOQUxfUkVMQVRJT05fUFRSX0xTVF9UWVBFIiwiZ2V0QWxsVmlzaXRzIiwiYWRkVGFza09uR3JvdXAiLCJncm91cElkIiwidGFza05hbWUiLCJwZXJpb2RpY2l0eU51bWJlciIsInBlcmlvZGljaXR5TWVzdXJlIiwidmlzaXROYW1lIiwiaW50ZXJ2ZW50aW9uTnVtYmVyIiwiaW50ZXJ2ZW50aW9uTWVzdXJlIiwiZGVzY3JpcHRpb24iLCJnZXRDaGlsZHJlbiIsImNoaWxkcmVuIiwiYXJnTm9kZUlkIiwibGVuZ3RoIiwiYWRkQ2hpbGQiLCJub2RlIiwiZ2V0SW5mbyIsImdldFB0clZhbHVlIiwibHN0IiwidGFzayIsIlZpc2l0TW9kZWwiLCJwZXJpb2RpY2l0eSIsIm51bWJlciIsIm1lc3VyZSIsImludGVydmVudGlvbiIsInZpc2l0VHlwZSIsInJlYWxOb2RlIiwiZ2V0UmVhbE5vZGUiLCJwdXNoIiwiaW5mbyIsInB0ck5hbWUiLCJpZCIsIlByb21pc2UiLCJyZXNvbHZlIiwiYWRkX2F0dHIiLCJ0YXNrcyIsIlB0ciIsIkxzdCIsImxvYWQiLCJ2YWx1ZSIsImdldEdyb3VwVGFza3MiLCJ2aXNpdHlUeXBlIiwicmVzIiwiZ2VuZXJhdGVFdmVudCIsImJlZ2luRGF0ZSIsImVuZERhdGUiLCJldmVudHNEYXRhIiwiY3JlYXRlVmlzaXRDb250ZXh0IiwibGlua0dyb3VwVG9WaXN0Q29udGV4dCIsImdldEV2ZW50U3RhdGVOb2RlIiwic3RhdGVOb2RlIiwiZXZlbnRJbmZvIiwiZXZlbnRzRGF0ZSIsIl9nZXREYXRlIiwicGVyaW9kTnVtYmVyIiwicGVyaW9kTWVzdXJlIiwiZGF0ZSIsImFkZEV2ZW50IiwiX2Zvcm1hdERhdGUiLCJEYXRlIiwiZ2V0VGltZSIsImNhdGNoIiwiZXJyIiwiY29uc29sZSIsImxvZyIsInN0YXRlSWQiLCJzdGF0ZSIsImV2ZW50IiwiRXZlbnRNb2RlbCIsImV2ZW50Tm9kZUlkIiwiZXZlbnRJZCIsIkVRVUlQTUVOVFNfVE9fRUxFTUVOVF9SRUxBVElPTiIsIm1hcCIsImNoaWxkIiwiVGFza01vZGVsIiwiZGJpZCIsImJpbUZpbGVJZCIsInRhc2tJZCIsImRiSWQiLCJ2aXNpdCIsImZpbmQiLCJjb250ZXh0TmFtZSIsInJlamVjdCIsInZpc2l0Q29udGV4dElkIiwiaSIsImV2ZW50U2F0ZSIsImVuZCIsImRpZmYiLCJ0b0RhdGUiLCJhZGQiLCJhcmdEYXRlIiwiZ2V0RGF0ZSIsImdldE1vbnRoIiwiZ2V0RnVsbFllYXIiLCJzcGluYWxWaXNpdFNlcnZpY2UiXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFB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LGtCQUFKLEVBQXpCOztrQkFFZXdJLGtCIiwiZmlsZSI6ImluZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgU1BJTkFMX1JFTEFUSU9OX1BUUl9MU1RfVFlQRSxcbiAgU3BpbmFsR3JhcGhTZXJ2aWNlXG59IGZyb20gXCJzcGluYWwtZW52LXZpZXdlci1ncmFwaC1zZXJ2aWNlXCI7XG5cbmltcG9ydCB7XG4gIEVRVUlQTUVOVFNfVE9fRUxFTUVOVF9SRUxBVElPTlxufSBmcm9tIFwic3BpbmFsLWVudi12aWV3ZXItcm9vbS1tYW5hZ2VyL2pzL3NlcnZpY2VcIjtcblxuaW1wb3J0IFZpc2l0TW9kZWwgZnJvbSBcIi4vbW9kZWxzL3Zpc2l0Lm1vZGVsLmpzXCI7XG5pbXBvcnQgRXZlbnRNb2RlbCBmcm9tIFwiLi9tb2RlbHMvZXZlbnQubW9kZWwuanNcIjtcbmltcG9ydCBUYXNrTW9kZWwgZnJvbSAnLi9tb2RlbHMvdGFzay5tb2RlbC5qcydcblxuaW1wb3J0IHtcbiAgUHRyLFxuICBMc3QsXG4gIE1vZGVsXG59IGZyb20gXCJzcGluYWwtY29yZS1jb25uZWN0b3Jqc190eXBlXCI7XG5cbmltcG9ydCBtb21lbnQgZnJvbSBcIm1vbWVudFwiO1xuXG4vLyBpbXBvcnQgT3BlcmF0aW9uTW9kZWwgZnJvbSBcIi4vb3BlcmF0aW9uTW9kZWxcIjtcbi8vIGltcG9ydCBWaXNpdE1vZGVsIGZyb20gXCIuL3Zpc2l0TW9kZWxcIjtcblxuY2xhc3MgU3BpbmFsVmlzaXRTZXJ2aWNlIHtcbiAgY29uc3RydWN0b3IoKSB7XG4gICAgdGhpcy5WSVNJVF9DT05URVhUX05BTUUgPSBcIi52aXNpdF9jb250ZXh0XCI7XG4gICAgdGhpcy5DT05URVhUX1RZUEUgPSBcInZpc2l0X2NvbnRleHRcIjtcblxuICAgIHRoaXMuVklTSVRfVFlQRSA9IFwidmlzaXRcIjtcblxuICAgIHRoaXMuTUFJTlRFTkFOQ0VfVklTSVQgPSBcIk1BSU5URU5BTkNFX1ZJU0lUXCI7XG4gICAgdGhpcy5SRUdVTEFUT1JZX1ZJU0lUID0gXCJSRUdVTEFUT1JZX1ZJU0lUXCI7XG4gICAgdGhpcy5TRUNVUklUWV9WSVNJVCA9IFwiU0VDVVJJVFlfVklTSVRcIjtcbiAgICB0aGlzLkRJQUdOT1NUSUNfVklTSVQgPSBcIkRJQUdOT1NUSUNfVklTSVRcIjtcblxuXG4gICAgdGhpcy5FVkVOVF9TVEFURVMgPSBPYmplY3QuZnJlZXplKHtcbiAgICAgIGRlY2xhcmVkOiBcImTDqWNsYXLDqVwiLFxuICAgICAgcHJvY2Vzc2luZzogXCJlbmNvdXJzXCIsXG4gICAgICBkb25lOiBcIsOpZmZlY3R1w6lcIlxuICAgIH0pXG5cbiAgICB0aGlzLlZJU0lUUyA9IE9iamVjdC5mcmVlemUoW3tcbiAgICAgICAgdHlwZTogdGhpcy5NQUlOVEVOQU5DRV9WSVNJVCxcbiAgICAgICAgbmFtZTogXCJNYWludGVuYWNlIHZpc2l0XCJcbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgIHR5cGU6IHRoaXMuUkVHVUxBVE9SWV9WSVNJVCxcbiAgICAgICAgbmFtZTogXCJSZWd1bGF0b3J5IHZpc2l0XCJcbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgIHR5cGU6IHRoaXMuU0VDVVJJVFlfVklTSVQsXG4gICAgICAgIG5hbWU6IFwiU2VjdXJpdHkgVmlzaXRcIlxuICAgICAgfSxcbiAgICAgIHtcbiAgICAgICAgdHlwZTogdGhpcy5ESUFHTk9TVElDX1ZJU0lULFxuICAgICAgICBuYW1lOiBcIkRpYWdub3N0aWMgdmlzaXRcIlxuICAgICAgfVxuICAgIF0pO1xuXG4gICAgLy9SRUxBVElPTlNcbiAgICAvLyB0aGlzLkNPTlRFWFRfVE9fVklTSVRfUkVMQVRJT04gPSBcImhhc1Zpc2l0XCI7XG4gICAgdGhpcy5HUk9VUF9UT19UQVNLID0gXCJoYXNUYXNrXCI7XG5cbiAgICB0aGlzLlZJU0lUX1RPX0dST1VQX1JFTEFUSU9OID0gXCJ2aXNpdEhhc0dyb3VwXCI7XG4gICAgdGhpcy5HUk9VUF9UT19FVkVOVF9TVEFURV9SRUxBVElPTiA9IFwiaGFzRXZlbnRTdGF0ZVwiO1xuICAgIHRoaXMuRVZFTlRfU1RBVEVfVE9fRVZFTlRfUkVMQVRJT04gPSBcImhhc0V2ZW50XCI7XG4gICAgdGhpcy5FVkVOVF9UT19UQVNLX1JFTEFUSU9OID0gXCJoYXNUYXNrXCI7XG4gICAgLy8gdGhpcy5UQVNLX1RPX1NUQVRFID0gXCJoYXNTdGF0ZVwiO1xuXG4gICAgLy8gdGhpcy5faW5pdCgpO1xuICB9XG5cbiAgX2luaXQoKSB7XG4gICAgU3BpbmFsR3JhcGhTZXJ2aWNlLndhaXRGb3JJbml0aWFsaXphdGlvbigpLnRoZW4oKCkgPT4ge1xuICAgICAgbGV0IGNvbnRleHQgPSBTcGluYWxHcmFwaFNlcnZpY2UuZ2V0Q29udGV4dCh0aGlzXG4gICAgICAgIC5WSVNJVF9DT05URVhUX05BTUUpO1xuXG4gICAgICBpZiAodHlwZW9mIGNvbnRleHQgIT09IFwidW5kZWZpbmVkXCIpIHJldHVybjtcblxuICAgICAgU3BpbmFsR3JhcGhTZXJ2aWNlLmFkZENvbnRleHQoXG4gICAgICAgIHRoaXMuVklTSVRfQ09OVEVYVF9OQU1FLFxuICAgICAgICB0aGlzLkNPTlRFWFRfVFlQRSxcbiAgICAgICAgbmV3IE1vZGVsKHtcbiAgICAgICAgICBuYW1lOiB0aGlzLlZJU0lUX0NPTlRFWFRfTkFNRVxuICAgICAgICB9KVxuICAgICAgKS50aGVuKGNvbnRleHRDcmVhdGVkID0+IHtcbiAgICAgICAgbGV0IGNvbnRleHRJZCA9IGNvbnRleHRDcmVhdGVkLmdldElkKCkuZ2V0KCk7XG5cbiAgICAgICAgdGhpcy5WSVNJVFMuZm9yRWFjaChlbCA9PiB7XG4gICAgICAgICAgbGV0IG5vZGVJZCA9IFNwaW5hbEdyYXBoU2VydmljZS5jcmVhdGVOb2RlKHtcbiAgICAgICAgICAgICAgbmFtZTogZWwubmFtZSxcbiAgICAgICAgICAgICAgdHlwZTogZWwudHlwZVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIG5ldyBNb2RlbCh7XG4gICAgICAgICAgICAgIG5hbWU6IGVsXG4gICAgICAgICAgICB9KVxuICAgICAgICAgICk7XG5cbiAgICAgICAgICBTcGluYWxHcmFwaFNlcnZpY2UuYWRkQ2hpbGRJbkNvbnRleHQoXG4gICAgICAgICAgICBjb250ZXh0SWQsXG4gICAgICAgICAgICBub2RlSWQsXG4gICAgICAgICAgICBjb250ZXh0SWQsXG4gICAgICAgICAgICB0aGlzLkNPTlRFWFRfVE9fVklTSVRfUkVMQVRJT04sXG4gICAgICAgICAgICBTUElOQUxfUkVMQVRJT05fUFRSX0xTVF9UWVBFXG4gICAgICAgICAgKTtcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG5cbiAgZ2V0QWxsVmlzaXRzKCkge1xuICAgIHJldHVybiB0aGlzLlZJU0lUUztcblxuICB9XG5cbiAgYWRkVGFza09uR3JvdXAoXG4gICAgZ3JvdXBJZCxcbiAgICB0YXNrTmFtZSxcbiAgICBwZXJpb2RpY2l0eU51bWJlcixcbiAgICBwZXJpb2RpY2l0eU1lc3VyZSxcbiAgICB2aXNpdE5hbWUsXG4gICAgaW50ZXJ2ZW50aW9uTnVtYmVyLFxuICAgIGludGVydmVudGlvbk1lc3VyZSxcbiAgICBkZXNjcmlwdGlvblxuICApIHtcblxuICAgIC8vIGxldCB2aXNpdE5hbWUgPSBTcGluYWxHcmFwaFNlcnZpY2UuZ2V0SW5mbyh2aXNpdElkKS50eXBlLmdldCgpO1xuXG4gICAgcmV0dXJuIFNwaW5hbEdyYXBoU2VydmljZS5nZXRDaGlsZHJlbihncm91cElkLCBbdGhpcy5HUk9VUF9UT19UQVNLXSkudGhlbihcbiAgICAgIGNoaWxkcmVuID0+IHtcblxuICAgICAgICBsZXQgYXJnTm9kZUlkO1xuICAgICAgICBpZiAoY2hpbGRyZW4ubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgYXJnTm9kZUlkID0gU3BpbmFsR3JhcGhTZXJ2aWNlLmNyZWF0ZU5vZGUoe1xuICAgICAgICAgICAgbmFtZTogXCJtYWludGVuYW5jZVwiXG4gICAgICAgICAgfSk7XG5cbiAgICAgICAgICBTcGluYWxHcmFwaFNlcnZpY2UuYWRkQ2hpbGQoXG4gICAgICAgICAgICBncm91cElkLFxuICAgICAgICAgICAgYXJnTm9kZUlkLFxuICAgICAgICAgICAgdGhpcy5HUk9VUF9UT19UQVNLLFxuICAgICAgICAgICAgU1BJTkFMX1JFTEFUSU9OX1BUUl9MU1RfVFlQRVxuICAgICAgICAgICk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgbm9kZSA9XG4gICAgICAgICAgdHlwZW9mIGFyZ05vZGVJZCAhPT0gXCJ1bmRlZmluZWRcIiA/XG4gICAgICAgICAgU3BpbmFsR3JhcGhTZXJ2aWNlLmdldEluZm8oYXJnTm9kZUlkKSA6XG4gICAgICAgICAgY2hpbGRyZW5bMF07XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0UHRyVmFsdWUobm9kZSwgdmlzaXROYW1lKS50aGVuKGxzdCA9PiB7XG5cbiAgICAgICAgICAvLyBsZXQgbm9kZUlkID0gdGhpcy5fcHJlcGFyZU5vZGUoZ3JvdXBJZCwgdGFza05hbWUsXG4gICAgICAgICAgLy8gICBwZXJpb2RpY2l0eU51bWJlcixcbiAgICAgICAgICAvLyAgIHBlcmlvZGljaXR5TWVzdXJlLFxuICAgICAgICAgIC8vICAgdmlzaXRJZCxcbiAgICAgICAgICAvLyAgIHZpc2l0TmFtZSxcbiAgICAgICAgICAvLyAgIGludGVydmVudGlvbk51bWJlcixcbiAgICAgICAgICAvLyAgIGludGVydmVudGlvbk1lc3VyZSxcbiAgICAgICAgICAvLyAgIGRlc2NyaXB0aW9uKTtcblxuICAgICAgICAgIC8vIFNwaW5hbEdyYXBoU2VydmljZS5hZGRDaGlsZCh2aXNpdElkLCBub2RlSWQsIHRoaXNcbiAgICAgICAgICAvLyAgIC5WSVNJVF9UT19UQVNLX1JFTEFUSU9OLCBTUElOQUxfUkVMQVRJT05fUFRSX0xTVF9UWVBFKTtcblxuXG5cbiAgICAgICAgICBsZXQgdGFzayA9IG5ldyBWaXNpdE1vZGVsKHRhc2tOYW1lLCBwZXJpb2RpY2l0eU51bWJlcixcbiAgICAgICAgICAgIHBlcmlvZGljaXR5TWVzdXJlLCB2aXNpdE5hbWUsIGludGVydmVudGlvbk51bWJlcixcbiAgICAgICAgICAgIGludGVydmVudGlvbk1lc3VyZSwgZGVzY3JpcHRpb24pO1xuXG4gICAgICAgICAgbGV0IG5vZGVJZCA9IFNwaW5hbEdyYXBoU2VydmljZS5jcmVhdGVOb2RlKHtcbiAgICAgICAgICAgIGdyb3VwSWQ6IGdyb3VwSWQsXG4gICAgICAgICAgICBuYW1lOiB0YXNrTmFtZSxcbiAgICAgICAgICAgIHBlcmlvZGljaXR5OiB7XG4gICAgICAgICAgICAgIG51bWJlcjogdGFzay5wZXJpb2RpY2l0eS5udW1iZXIuZ2V0KCksXG4gICAgICAgICAgICAgIG1lc3VyZTogdGFzay5wZXJpb2RpY2l0eS5tZXN1cmUuZ2V0KClcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBpbnRlcnZlbnRpb246IHtcbiAgICAgICAgICAgICAgbnVtYmVyOiB0YXNrLmludGVydmVudGlvbi5udW1iZXIuZ2V0KCksXG4gICAgICAgICAgICAgIG1lc3VyZTogdGFzay5pbnRlcnZlbnRpb24ubWVzdXJlLmdldCgpXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgdmlzaXRUeXBlOiB2aXNpdE5hbWUsXG4gICAgICAgICAgICBkZXNjcmlwdGlvbjogZGVzY3JpcHRpb25cblxuICAgICAgICAgIH0sIHRhc2spO1xuXG5cbiAgICAgICAgICBsZXQgcmVhbE5vZGUgPSBTcGluYWxHcmFwaFNlcnZpY2UuZ2V0UmVhbE5vZGUobm9kZUlkKTtcblxuICAgICAgICAgIGxzdC5wdXNoKHJlYWxOb2RlKTtcblxuICAgICAgICAgIHJldHVybiByZWFsTm9kZS5pbmZvO1xuXG4gICAgICAgIH0pXG4gICAgICB9XG4gICAgKTtcblxuICAgIC8vIGxldCB0YXNrID0gbmV3IFZpc2l0TW9kZWwodGFza05hbWUsIGJlZ2luRGF0ZSwgcGVyaW9kaWNpdHlOdW1iZXIsXG4gICAgLy8gICBwZXJpb2RpY2l0eU1lc3VyZSxcbiAgICAvLyAgIHZpc2l0SWQsIHZpc2l0TmFtZSk7XG5cbiAgICAvLyBsZXQgbm9kZUlkID0gU3BpbmFsR3JhcGhTZXJ2aWNlLmNyZWF0ZU5vZGUoe1xuICAgIC8vICAgbmFtZTogdGFza05hbWUsXG4gICAgLy8gICB0eXBlOiBcInRhc2tcIixcbiAgICAvLyAgIHZpc2l0SWQ6IHZpc2l0SWRcbiAgICAvLyB9LCB0YXNrKTtcblxuICAgIC8vIC8vIHJldHVybiBTcGluYWxHcmFwaFNlcnZpY2UuYWRkQ2hpbGQoZ3JvdXBJZCwgbm9kZUlkLCB0aGlzLkdST1VQX1RPX1RBU0ssXG4gICAgLy8gLy8gICBTUElOQUxfUkVMQVRJT05fUFRSX0xTVF9UWVBFKS50aGVuKGVsID0+IHtcbiAgICAvLyAvLyAgIGlmIChlbCkge1xuICAgIC8vIC8vICAgICB0aGlzLmFkZE9wZXJhdGlvbnMoZ3JvdXBJZCwgbm9kZUlkLCBiZWdpbkRhdGUpO1xuICAgIC8vIC8vICAgICByZXR1cm4gdGFzaztcbiAgICAvLyAvLyAgIH1cbiAgICAvLyAvLyB9KVxuICB9XG5cbiAgZ2V0UHRyVmFsdWUobm9kZSwgcHRyTmFtZSkge1xuICAgIGxldCByZWFsTm9kZSA9IFNwaW5hbEdyYXBoU2VydmljZS5nZXRSZWFsTm9kZShub2RlLmlkLmdldCgpKTtcblxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xuICAgICAgaWYgKCFyZWFsTm9kZS5pbmZvW3B0ck5hbWVdKSB7XG4gICAgICAgIHJlYWxOb2RlLmluZm8uYWRkX2F0dHIocHRyTmFtZSwge1xuICAgICAgICAgIHRhc2tzOiBuZXcgUHRyKG5ldyBMc3QoKSlcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIHJlYWxOb2RlLmluZm9bcHRyTmFtZV0udGFza3MubG9hZCgodmFsdWUpID0+IHtcbiAgICAgICAgcmV0dXJuIHJlc29sdmUodmFsdWUpO1xuICAgICAgfSlcbiAgICB9KVxuXG5cbiAgfVxuXG4gIGdldEdyb3VwVGFza3MoZ3JvdXBJZCwgdmlzaXR5VHlwZSkge1xuICAgIHJldHVybiBTcGluYWxHcmFwaFNlcnZpY2UuZ2V0Q2hpbGRyZW4oZ3JvdXBJZCwgW3RoaXMuR1JPVVBfVE9fVEFTS10pLnRoZW4oXG4gICAgICByZXMgPT4ge1xuICAgICAgICBsZXQgbm9kZUlkO1xuICAgICAgICBpZiAocmVzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgIG5vZGVJZCA9IFNwaW5hbEdyYXBoU2VydmljZS5jcmVhdGVOb2RlKHtcbiAgICAgICAgICAgIG5hbWU6IFwibWFpbnRlbmFuY2VcIlxuICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgU3BpbmFsR3JhcGhTZXJ2aWNlLmFkZENoaWxkKFxuICAgICAgICAgICAgZ3JvdXBJZCxcbiAgICAgICAgICAgIG5vZGVJZCxcbiAgICAgICAgICAgIHRoaXMuR1JPVVBfVE9fVEFTSyxcbiAgICAgICAgICAgIFNQSU5BTF9SRUxBVElPTl9QVFJfTFNUX1RZUEVcbiAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IG5vZGUgPVxuICAgICAgICAgIHR5cGVvZiBub2RlSWQgIT09IFwidW5kZWZpbmVkXCIgP1xuICAgICAgICAgIFNwaW5hbEdyYXBoU2VydmljZS5nZXRJbmZvKG5vZGVJZCkgOlxuICAgICAgICAgIHJlc1swXTtcblxuICAgICAgICByZXR1cm4gdGhpcy5nZXRQdHJWYWx1ZShub2RlLCB2aXNpdHlUeXBlKTtcbiAgICAgIH0pO1xuXG4gIH1cblxuXG5cbiAgZ2VuZXJhdGVFdmVudCh2aXNpdFR5cGUsIGdyb3VwSWQsIGJlZ2luRGF0ZSwgZW5kRGF0ZSwgZXZlbnRzRGF0YSkge1xuXG4gICAgcmV0dXJuIHRoaXMuY3JlYXRlVmlzaXRDb250ZXh0KHZpc2l0VHlwZSlcbiAgICAgIC50aGVuKGVsID0+IHtcblxuICAgICAgICByZXR1cm4gdGhpcy5saW5rR3JvdXBUb1Zpc3RDb250ZXh0KGVsLmlkLmdldCgpLCBncm91cElkKS50aGVuKFxuICAgICAgICAgIHJlcyA9PiB7XG5cbiAgICAgICAgICAgIGlmIChyZXMpIHtcbiAgICAgICAgICAgICAgdGhpcy5nZXRFdmVudFN0YXRlTm9kZShncm91cElkLCB0aGlzXG4gICAgICAgICAgICAgICAgLkVWRU5UX1NUQVRFUy5kZWNsYXJlZCkudGhlbihzdGF0ZU5vZGUgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBpZCA9IHN0YXRlTm9kZS5pZC5nZXQoKTtcblxuICAgICAgICAgICAgICAgIGV2ZW50c0RhdGEuZm9yRWFjaChldmVudEluZm8gPT4ge1xuICAgICAgICAgICAgICAgICAgbGV0IGV2ZW50c0RhdGUgPSB0aGlzLl9nZXREYXRlKGJlZ2luRGF0ZSxcbiAgICAgICAgICAgICAgICAgICAgZW5kRGF0ZSxcbiAgICAgICAgICAgICAgICAgICAgZXZlbnRJbmZvLnBlcmlvZE51bWJlciwgZXZlbnRJbmZvXG4gICAgICAgICAgICAgICAgICAgIC5wZXJpb2RNZXN1cmUpO1xuXG4gICAgICAgICAgICAgICAgICBldmVudHNEYXRlLmZvckVhY2goKGRhdGUpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hZGRFdmVudChncm91cElkLCBpZCwgZXZlbnRJbmZvLm5hbWUsXG4gICAgICAgICAgICAgICAgICAgICAgYCR7ZXZlbnRJbmZvLm5hbWV9XyR7dGhpcy5fZm9ybWF0RGF0ZShkYXRlKX1gLFxuICAgICAgICAgICAgICAgICAgICAgIG5ldyBEYXRlKGRhdGUpLmdldFRpbWUoKVxuICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIH0pXG5cbiAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KTtcbiAgICAgIH0pXG4gICAgICAuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgY29uc29sZS5sb2coZXJyKTtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShlcnIpO1xuICAgICAgfSlcblxuXG4gIH1cblxuXG4gIGFkZEV2ZW50KGdyb3VwSWQsIHN0YXRlSWQsIHRhc2tOYW1lLCBuYW1lLCBkYXRlKSB7XG5cblxuICAgIGxldCBzdGF0ZSA9IFNwaW5hbEdyYXBoU2VydmljZS5nZXRJbmZvKHN0YXRlSWQpLm5hbWUuZ2V0KCk7XG5cbiAgICBsZXQgZXZlbnQgPSBuZXcgRXZlbnRNb2RlbChuYW1lLCBkYXRlLCBzdGF0ZSwgZ3JvdXBJZCk7XG5cbiAgICBsZXQgZXZlbnROb2RlSWQgPSBTcGluYWxHcmFwaFNlcnZpY2UuY3JlYXRlTm9kZSh7XG4gICAgICBuYW1lOiBuYW1lLFxuICAgICAgZGF0ZTogZGF0ZSxcbiAgICAgIHN0YXRlOiBzdGF0ZSxcbiAgICAgIGdyb3VwSWQ6IGdyb3VwSWRcbiAgICB9LCBldmVudCk7XG5cbiAgICByZXR1cm4gU3BpbmFsR3JhcGhTZXJ2aWNlLmFkZENoaWxkKHN0YXRlSWQsIGV2ZW50Tm9kZUlkLFxuICAgICAgdGhpcy5FVkVOVF9TVEFURV9UT19FVkVOVF9SRUxBVElPTiwgU1BJTkFMX1JFTEFUSU9OX1BUUl9MU1RfVFlQRVxuICAgICkudGhlbihlbCA9PiB7XG4gICAgICBpZiAoZWwpIHJldHVybiBldmVudE5vZGVJZDtcbiAgICB9KS50aGVuKGV2ZW50SWQgPT4ge1xuXG4gICAgICBpZiAodHlwZW9mIGV2ZW50SWQgIT09IFwidW5kZWZpbmVkXCIpIHtcbiAgICAgICAgcmV0dXJuIFNwaW5hbEdyYXBoU2VydmljZS5nZXRDaGlsZHJlbihncm91cElkLCBbXG4gICAgICAgICAgRVFVSVBNRU5UU19UT19FTEVNRU5UX1JFTEFUSU9OXG4gICAgICAgIF0pLnRoZW4oXG4gICAgICAgICAgY2hpbGRyZW4gPT4ge1xuXG4gICAgICAgICAgICByZXR1cm4gY2hpbGRyZW4ubWFwKGNoaWxkID0+IHtcbiAgICAgICAgICAgICAgbGV0IHRhc2sgPSBuZXcgVGFza01vZGVsKGNoaWxkLm5hbWUuZ2V0KCksIGNoaWxkLmRiaWRcbiAgICAgICAgICAgICAgICAuZ2V0KCksIGNoaWxkLmJpbUZpbGVJZC5nZXQoKSwgdGFza05hbWUsIDApO1xuXG5cbiAgICAgICAgICAgICAgbGV0IHRhc2tJZCA9IFNwaW5hbEdyYXBoU2VydmljZS5jcmVhdGVOb2RlKHtcbiAgICAgICAgICAgICAgICBuYW1lOiBjaGlsZC5uYW1lLmdldCgpLFxuICAgICAgICAgICAgICAgIGRiSWQ6IGNoaWxkLmRiaWQuZ2V0KCksXG4gICAgICAgICAgICAgICAgYmltRmlsZUlkOiBjaGlsZC5iaW1GaWxlSWQuZ2V0KCksXG4gICAgICAgICAgICAgICAgdGFza05hbWU6IHRhc2tOYW1lLFxuICAgICAgICAgICAgICAgIHN0YXRlOiB0YXNrLnN0YXRlLmdldCgpXG4gICAgICAgICAgICAgIH0sIHRhc2spO1xuXG4gICAgICAgICAgICAgIHJldHVybiBTcGluYWxHcmFwaFNlcnZpY2UuYWRkQ2hpbGQoZXZlbnRJZCwgdGFza0lkLFxuICAgICAgICAgICAgICAgIHRoaXNcbiAgICAgICAgICAgICAgICAuRVZFTlRfVE9fVEFTS19SRUxBVElPTixcbiAgICAgICAgICAgICAgICBTUElOQUxfUkVMQVRJT05fUFRSX0xTVF9UWVBFKVxuXG4gICAgICAgICAgICB9KVxuXG4gICAgICAgICAgfSlcbiAgICAgIH1cblxuICAgIH0pXG5cbiAgfVxuXG5cbiAgY3JlYXRlVmlzaXRDb250ZXh0KHZpc2l0VHlwZSkge1xuXG4gICAgbGV0IHZpc2l0ID0gdGhpcy5WSVNJVFMuZmluZChlbCA9PiB7XG4gICAgICByZXR1cm4gZWwudHlwZSA9PT0gdmlzaXRUeXBlO1xuICAgIH0pXG5cbiAgICBpZiAodHlwZW9mIHZpc2l0ICE9PSBcInVuZGVmaW5lZFwiKSB7XG4gICAgICBjb25zdCBjb250ZXh0TmFtZSA9IGAuJHt2aXNpdC5uYW1lfWA7XG5cbiAgICAgIGxldCBjb250ZXh0ID0gU3BpbmFsR3JhcGhTZXJ2aWNlLmdldENvbnRleHQoY29udGV4dE5hbWUpO1xuICAgICAgaWYgKHR5cGVvZiBjb250ZXh0ICE9PSBcInVuZGVmaW5lZFwiKSByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGNvbnRleHRcbiAgICAgICAgLmluZm8pO1xuXG4gICAgICByZXR1cm4gU3BpbmFsR3JhcGhTZXJ2aWNlLmFkZENvbnRleHQoY29udGV4dE5hbWUsIHZpc2l0VHlwZSwgbmV3IE1vZGVsKHtcbiAgICAgICAgbmFtZTogdGhpcy5WSVNJVF9DT05URVhUX05BTUVcbiAgICAgIH0pKS50aGVuKGNvbnRleHRDcmVhdGVkID0+IHtcbiAgICAgICAgcmV0dXJuIGNvbnRleHRDcmVhdGVkLmluZm87XG4gICAgICB9KTtcblxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoXCJ2aXNpdE5vdEZvdW5kXCIpO1xuICAgIH1cblxuICB9XG5cblxuICBsaW5rR3JvdXBUb1Zpc3RDb250ZXh0KHZpc2l0Q29udGV4dElkLCBncm91cElkKSB7XG4gICAgcmV0dXJuIFNwaW5hbEdyYXBoU2VydmljZS5nZXRDaGlsZHJlbih2aXNpdENvbnRleHRJZCwgW3RoaXNcbiAgICAgIC5WSVNJVF9UT19HUk9VUF9SRUxBVElPTlxuICAgIF0pLnRoZW4oY2hpbGRyZW4gPT4ge1xuXG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGNvbnN0IGNoaWxkID0gY2hpbGRyZW5baV0uaWQuZ2V0KCk7XG4gICAgICAgIGlmIChjaGlsZCA9PT0gZ3JvdXBJZCkgcmV0dXJuIHRydWU7XG4gICAgICB9XG5cbiAgICB9KS50aGVuKGVsID0+IHtcblxuICAgICAgaWYgKHR5cGVvZiBlbCA9PT0gXCJ1bmRlZmluZWRcIikge1xuXG4gICAgICAgIHJldHVybiBTcGluYWxHcmFwaFNlcnZpY2UuYWRkQ2hpbGQodmlzaXRDb250ZXh0SWQsIGdyb3VwSWQsIHRoaXNcbiAgICAgICAgICAuVklTSVRfVE9fR1JPVVBfUkVMQVRJT04sIFNQSU5BTF9SRUxBVElPTl9QVFJfTFNUX1RZUEUpLnRoZW4oXG4gICAgICAgICAgYXN5bmMgcmVzID0+IHtcblxuICAgICAgICAgICAgaWYgKHJlcykge1xuICAgICAgICAgICAgICBhd2FpdCB0aGlzLmdldEV2ZW50U3RhdGVOb2RlKGdyb3VwSWQsIHRoaXMuRVZFTlRfU1RBVEVTXG4gICAgICAgICAgICAgICAgLnByb2Nlc3NpbmcpO1xuICAgICAgICAgICAgICBhd2FpdCB0aGlzLmdldEV2ZW50U3RhdGVOb2RlKGdyb3VwSWQsIHRoaXMuRVZFTlRfU1RBVEVTXG4gICAgICAgICAgICAgICAgLmRvbmUpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gcmVzO1xuXG4gICAgICAgICAgfSlcbiAgICAgIH0gZWxzZSB7XG5cbiAgICAgICAgcmV0dXJuIGVsO1xuICAgICAgfVxuXG4gICAgfSlcbiAgfVxuXG5cbiAgZ2V0RXZlbnRTdGF0ZU5vZGUoZ3JvdXBJZCwgZXZlbnRTYXRlKSB7XG4gICAgcmV0dXJuIFNwaW5hbEdyYXBoU2VydmljZS5nZXRDaGlsZHJlbihncm91cElkLCBbdGhpc1xuICAgICAgICAuR1JPVVBfVE9fRVZFTlRfU1RBVEVfUkVMQVRJT05cbiAgICAgIF0pXG4gICAgICAudGhlbihjaGlsZHJlbiA9PiB7XG5cbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjaGlsZHJlbi5sZW5ndGg7IGkrKykge1xuICAgICAgICAgIGNvbnN0IG5hbWUgPSBjaGlsZHJlbltpXS5uYW1lLmdldCgpO1xuXG4gICAgICAgICAgaWYgKG5hbWUgPT09IGV2ZW50U2F0ZSkge1xuICAgICAgICAgICAgcmV0dXJuIGNoaWxkcmVuW2ldO1xuICAgICAgICAgIH1cblxuICAgICAgICB9XG5cbiAgICAgIH0pLnRoZW4oZWwgPT4ge1xuICAgICAgICBpZiAodHlwZW9mIGVsID09PSBcInVuZGVmaW5lZFwiKSB7XG4gICAgICAgICAgbGV0IGFyZ05vZGVJZCA9IFNwaW5hbEdyYXBoU2VydmljZS5jcmVhdGVOb2RlKHtcbiAgICAgICAgICAgIG5hbWU6IGV2ZW50U2F0ZSxcbiAgICAgICAgICAgIHN0YXRlOiBldmVudFNhdGUsXG4gICAgICAgICAgICB0eXBlOiBcIkV2ZW50U3RhdGVcIlxuICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgcmV0dXJuIFNwaW5hbEdyYXBoU2VydmljZS5hZGRDaGlsZChncm91cElkLFxuICAgICAgICAgICAgYXJnTm9kZUlkLFxuICAgICAgICAgICAgdGhpcy5HUk9VUF9UT19FVkVOVF9TVEFURV9SRUxBVElPTixcbiAgICAgICAgICAgIFNQSU5BTF9SRUxBVElPTl9QVFJfTFNUX1RZUEUpLnRoZW4ocmVzID0+IHtcbiAgICAgICAgICAgIGlmIChyZXMpIHJldHVybiBTcGluYWxHcmFwaFNlcnZpY2UuZ2V0SW5mbyhcbiAgICAgICAgICAgICAgYXJnTm9kZUlkKTtcbiAgICAgICAgICB9KVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiBlbDtcbiAgICAgICAgfVxuXG4gICAgICB9KVxuICB9XG5cblxuICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgLy8gICAgICAgICAgICAgICAgICAgICAgICAgICAgUFJJVkFURVMgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vXG4gIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG5cbiAgX2dldERhdGUoYmVnaW5EYXRlLCBlbmREYXRlLCBwZXJpb2ROdW1iZXIsIHBlcmlvZE1lc3VyZSkge1xuXG4gICAgbGV0IG1lc3VyZSA9IFsnZGF5cycsICd3ZWVrcycsICdtb250aHMnLCAneWVhcnMnXVtwZXJpb2RNZXN1cmVdO1xuXG4gICAgbGV0IGV2ZW50c0RhdGUgPSBbXTtcblxuICAgIGxldCBkYXRlID0gbW9tZW50KGJlZ2luRGF0ZSk7XG4gICAgbGV0IGVuZCA9IG1vbWVudChlbmREYXRlKTtcblxuICAgIHdoaWxlIChlbmQuZGlmZihkYXRlKSA+PSAwKSB7XG4gICAgICBldmVudHNEYXRlLnB1c2goZGF0ZS50b0RhdGUoKSk7XG5cbiAgICAgIGRhdGUgPSBkYXRlLmFkZChwZXJpb2ROdW1iZXIsIG1lc3VyZSk7XG4gICAgfVxuXG5cbiAgICByZXR1cm4gZXZlbnRzRGF0ZTtcblxuICB9XG5cbiAgX2Zvcm1hdERhdGUoYXJnRGF0ZSkge1xuICAgIGxldCBkYXRlID0gbmV3IERhdGUoYXJnRGF0ZSk7XG5cbiAgICByZXR1cm4gYCR7ZGF0ZS5nZXREYXRlKCl9LyR7ZGF0ZS5nZXRNb250aCgpICsgMX0vJHtkYXRlLmdldEZ1bGxZZWFyKCl9YDtcbiAgfVxuXG59XG5cbmxldCBzcGluYWxWaXNpdFNlcnZpY2UgPSBuZXcgU3BpbmFsVmlzaXRTZXJ2aWNlKCk7XG5cbmV4cG9ydCBkZWZhdWx0IHNwaW5hbFZpc2l0U2VydmljZTsiXX0=