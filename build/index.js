"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _spinalEnvViewerGraphService = require("spinal-env-viewer-graph-service");

var _service = require("spinal-env-viewer-room-manager/js/service");

var _visitModel = require("./models/visit.model.js");

var _visitModel2 = _interopRequireDefault(_visitModel);

var _spinalCoreConnectorjs_type = require("spinal-core-connectorjs_type");

var _moment = require("moment");

var _moment2 = _interopRequireDefault(_moment);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

// import OperationModel from "./operationModel";
// import VisitModel from "./visitModel";

class SpinalVisitService {
  constructor() {
    this.VISIT_CONTEXT_NAME = ".visit_context";
    this.CONTEXT_TYPE = "visit_context";

    this.VISIT_TYPE = "visit";

    this.MAINTENANCE_VISIT = "MAINTENANCE_VISIT";
    this.REGULATORY_VISIT = "REGULATORY_VISIT";
    this.SECURITY_VISIT = "SECURITY_VISIT";
    this.DIAGNOSTIC_VISIT = "DIAGNOSTIC_VISIT";

    this.VISITS = Object.freeze([{
      type: this.MAINTENANCE_VISIT,
      name: "Maintenace visit"
    }, {
      type: this.REGULATORY_VISIT,
      name: "Regulatory visit"
    }, {
      type: this.SECURITY_VISIT,
      name: "Security Visit"
    }, {
      type: this.DIAGNOSTIC_VISIT,
      name: "Diagnostic visit"
    }]);

    //RELATIONS
    // this.CONTEXT_TO_VISIT_RELATION = "hasVisit";
    this.GROUP_TO_TASK = "hasTask";

    this.VISIT_TO_GROUP_RELATION = "visitHasGroup";
    this.GROUP_TO_EVENT_RELATION = "hasEventState";
    // this.TASK_TO_STATE = "hasState";

    // this._init();
  }

  _init() {
    _spinalEnvViewerGraphService.SpinalGraphService.waitForInitialization().then(() => {
      let context = _spinalEnvViewerGraphService.SpinalGraphService.getContext(this.VISIT_CONTEXT_NAME);

      if (typeof context !== "undefined") return;

      _spinalEnvViewerGraphService.SpinalGraphService.addContext(this.VISIT_CONTEXT_NAME, this.CONTEXT_TYPE, new _spinalCoreConnectorjs_type.Model({
        name: this.VISIT_CONTEXT_NAME
      })).then(contextCreated => {
        let contextId = contextCreated.getId().get();

        this.VISITS.forEach(el => {
          let nodeId = _spinalEnvViewerGraphService.SpinalGraphService.createNode({
            name: el.name,
            type: el.type
          }, new _spinalCoreConnectorjs_type.Model({
            name: el
          }));

          _spinalEnvViewerGraphService.SpinalGraphService.addChildInContext(contextId, nodeId, contextId, this.CONTEXT_TO_VISIT_RELATION, _spinalEnvViewerGraphService.SPINAL_RELATION_PTR_LST_TYPE);
        });
      });
    });
  }

  getAllVisits() {
    return this.VISITS;
  }

  addTaskOnGroup(groupId, taskName, periodicityNumber, periodicityMesure, visitName, interventionNumber, interventionMesure, description) {

    // let visitName = SpinalGraphService.getInfo(visitId).type.get();

    return _spinalEnvViewerGraphService.SpinalGraphService.getChildren(groupId, [this.GROUP_TO_TASK]).then(children => {

      let argNodeId;
      if (children.length === 0) {
        argNodeId = _spinalEnvViewerGraphService.SpinalGraphService.createNode({
          name: "maintenance"
        });

        _spinalEnvViewerGraphService.SpinalGraphService.addChild(groupId, argNodeId, this.GROUP_TO_TASK, _spinalEnvViewerGraphService.SPINAL_RELATION_PTR_LST_TYPE);
      }

      let node = typeof argNodeId !== "undefined" ? _spinalEnvViewerGraphService.SpinalGraphService.getInfo(argNodeId) : children[0];

      return this.getPtrValue(node, visitName).then(lst => {

        // let nodeId = this._prepareNode(groupId, taskName,
        //   periodicityNumber,
        //   periodicityMesure,
        //   visitId,
        //   visitName,
        //   interventionNumber,
        //   interventionMesure,
        //   description);

        // SpinalGraphService.addChild(visitId, nodeId, this
        //   .VISIT_TO_TASK_RELATION, SPINAL_RELATION_PTR_LST_TYPE);


        let task = new _visitModel2.default(taskName, periodicityNumber, periodicityMesure, visitName, interventionNumber, interventionMesure, description);

        let nodeId = _spinalEnvViewerGraphService.SpinalGraphService.createNode({
          groupId: groupId,
          name: taskName,
          periodicity: {
            number: task.periodicity.number.get(),
            mesure: task.periodicity.mesure.get()
          },
          intervention: {
            number: task.intervention.number.get(),
            mesure: task.intervention.mesure.get()
          },
          visitType: visitName,
          description: description

        }, task);

        let realNode = _spinalEnvViewerGraphService.SpinalGraphService.getRealNode(nodeId);

        lst.push(realNode);

        return realNode.info;
      });
    });

    // let task = new VisitModel(taskName, beginDate, periodicityNumber,
    //   periodicityMesure,
    //   visitId, visitName);

    // let nodeId = SpinalGraphService.createNode({
    //   name: taskName,
    //   type: "task",
    //   visitId: visitId
    // }, task);

    // // return SpinalGraphService.addChild(groupId, nodeId, this.GROUP_TO_TASK,
    // //   SPINAL_RELATION_PTR_LST_TYPE).then(el => {
    // //   if (el) {
    // //     this.addOperations(groupId, nodeId, beginDate);
    // //     return task;
    // //   }
    // // })
  }

  getPtrValue(node, ptrName) {
    let realNode = _spinalEnvViewerGraphService.SpinalGraphService.getRealNode(node.id.get());

    return new Promise(resolve => {
      if (!realNode.info[ptrName]) {
        realNode.info.add_attr(ptrName, {
          tasks: new _spinalCoreConnectorjs_type.Ptr(new _spinalCoreConnectorjs_type.Lst())
        });
      }

      realNode.info[ptrName].tasks.load(value => {
        return resolve(value);
      });
    });
  }

  getGroupTasks(groupId, visityType) {
    return _spinalEnvViewerGraphService.SpinalGraphService.getChildren(groupId, [this.GROUP_TO_TASK]).then(res => {
      let nodeId;
      if (res.length === 0) {
        nodeId = _spinalEnvViewerGraphService.SpinalGraphService.createNode({
          name: "maintenance"
        });

        _spinalEnvViewerGraphService.SpinalGraphService.addChild(groupId, nodeId, this.GROUP_TO_TASK, _spinalEnvViewerGraphService.SPINAL_RELATION_PTR_LST_TYPE);
      }

      let node = typeof nodeId !== "undefined" ? _spinalEnvViewerGraphService.SpinalGraphService.getInfo(nodeId) : res[0];

      return this.getPtrValue(node, visityType);
    });
  }

  generateEvent(visitType, groupId, eventsData) {

    // console.log("inside js", visitType, groupId, taskName, beginDate, endDate,
    //   periodicityNumber, periodicityMesure);


    return this.createVisitContext(visitType).then(el => {
      console.log("el", el);
      return this.linkGroupToVistContext(el.id.get(), groupId).then(res => {
        console.log("res", res);
        if (res) {
          this.addEvent(groupId, "déclaré");
          this.addEvent(groupId, "Encours");
          this.addEvent(groupId, "Effectué");
          this.addEvent(groupId, "déclaré");
          this.addEvent(groupId, "Encours");
          this.addEvent(groupId, "Effectué");
          this.addEvent(groupId, "déclaré");
          this.addEvent(groupId, "Encours");
          this.addEvent(groupId, "Effectué");
          this.addEvent(groupId, "déclaré");
          this.addEvent(groupId, "Encours");
          this.addEvent(groupId, "Effectué");
        }
      });
    }).catch(err => {
      console.log(err);
      return Promise.resolve(err);
    });
  }

  addEvent(groupId, state, name, date) {
    return this.getEventStateNode(groupId, state).then(eventStateNode => {
      console.log("eventStateNode", eventStateNode);
    });
  }

  createVisitContext(visitType) {

    let visit = this.VISITS.find(el => {
      return el.type === visitType;
    });

    if (typeof visit !== "undefined") {
      const contextName = `.${visit.name}`;

      let context = _spinalEnvViewerGraphService.SpinalGraphService.getContext(contextName);
      if (typeof context !== "undefined") return Promise.resolve(context.info);

      return _spinalEnvViewerGraphService.SpinalGraphService.addContext(contextName, visitType, new _spinalCoreConnectorjs_type.Model({
        name: this.VISIT_CONTEXT_NAME
      })).then(contextCreated => {
        return contextCreated.info;
      });
    } else {
      return Promise.reject("visitNotFound");
    }
  }

  linkGroupToVistContext(visitContextId, groupId) {
    return _spinalEnvViewerGraphService.SpinalGraphService.getChildren(visitContextId, [this.VISIT_TO_GROUP_RELATION]).then(children => {
      console.log("children", children);

      for (let i = 0; i < children.length; i++) {
        const child = children[i].id.get();
        if (child === groupId) return true;
      }
    }).then(el => {

      console.log("el2222", el);

      if (typeof el === "undefined") {
        console.log("yes el222 is undefined", visitContextId, groupId);
        return _spinalEnvViewerGraphService.SpinalGraphService.addChild(visitContextId, groupId, this.VISIT_TO_GROUP_RELATION, _spinalEnvViewerGraphService.SPINAL_RELATION_PTR_LST_TYPE);
      } else {
        console.log("node not undefined");

        return el;
      }
    });
  }

  getEventStateNode(groupId, eventSate) {
    return _spinalEnvViewerGraphService.SpinalGraphService.getChildren(groupId, [this.GROUP_TO_EVENT_RELATION]).then(children => {

      for (let i = 0; i < children.length; i++) {
        const name = children[i].name.get();

        if (name === eventSate) {
          return children[i];
        }
      }
    }).then(el => {
      if (typeof el === "undefined") {
        let argNodeId = _spinalEnvViewerGraphService.SpinalGraphService.createNode({
          name: eventSate,
          state: eventSate,
          type: "EventState"
        });

        return _spinalEnvViewerGraphService.SpinalGraphService.addChild(groupId, argNodeId, this.GROUP_TO_EVENT_RELATION, _spinalEnvViewerGraphService.SPINAL_RELATION_PTR_LST_TYPE).then(res => {
          if (res) return _spinalEnvViewerGraphService.SpinalGraphService.getInfo(argNodeId);
        });
      } else {
        return el;
      }
    });
  }

}

let spinalVisitService = new SpinalVisitService();

exports.default = spinalVisitService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJTcGluYWxWaXNpdFNlcnZpY2UiLCJjb25zdHJ1Y3RvciIsIlZJU0lUX0NPTlRFWFRfTkFNRSIsIkNPTlRFWFRfVFlQRSIsIlZJU0lUX1RZUEUiLCJNQUlOVEVOQU5DRV9WSVNJVCIsIlJFR1VMQVRPUllfVklTSVQiLCJTRUNVUklUWV9WSVNJVCIsIkRJQUdOT1NUSUNfVklTSVQiLCJWSVNJVFMiLCJPYmplY3QiLCJmcmVlemUiLCJ0eXBlIiwibmFtZSIsIkdST1VQX1RPX1RBU0siLCJWSVNJVF9UT19HUk9VUF9SRUxBVElPTiIsIkdST1VQX1RPX0VWRU5UX1JFTEFUSU9OIiwiX2luaXQiLCJTcGluYWxHcmFwaFNlcnZpY2UiLCJ3YWl0Rm9ySW5pdGlhbGl6YXRpb24iLCJ0aGVuIiwiY29udGV4dCIsImdldENvbnRleHQiLCJhZGRDb250ZXh0IiwiTW9kZWwiLCJjb250ZXh0Q3JlYXRlZCIsImNvbnRleHRJZCIsImdldElkIiwiZ2V0IiwiZm9yRWFjaCIsImVsIiwibm9kZUlkIiwiY3JlYXRlTm9kZSIsImFkZENoaWxkSW5Db250ZXh0IiwiQ09OVEVYVF9UT19WSVNJVF9SRUxBVElPTiIsIlNQSU5BTF9SRUxBVElPTl9QVFJfTFNUX1RZUEUiLCJnZXRBbGxWaXNpdHMiLCJhZGRUYXNrT25Hcm91cCIsImdyb3VwSWQiLCJ0YXNrTmFtZSIsInBlcmlvZGljaXR5TnVtYmVyIiwicGVyaW9kaWNpdHlNZXN1cmUiLCJ2aXNpdE5hbWUiLCJpbnRlcnZlbnRpb25OdW1iZXIiLCJpbnRlcnZlbnRpb25NZXN1cmUiLCJkZXNjcmlwdGlvbiIsImdldENoaWxkcmVuIiwiY2hpbGRyZW4iLCJhcmdOb2RlSWQiLCJsZW5ndGgiLCJhZGRDaGlsZCIsIm5vZGUiLCJnZXRJbmZvIiwiZ2V0UHRyVmFsdWUiLCJsc3QiLCJ0YXNrIiwiVmlzaXRNb2RlbCIsInBlcmlvZGljaXR5IiwibnVtYmVyIiwibWVzdXJlIiwiaW50ZXJ2ZW50aW9uIiwidmlzaXRUeXBlIiwicmVhbE5vZGUiLCJnZXRSZWFsTm9kZSIsInB1c2giLCJpbmZvIiwicHRyTmFtZSIsImlkIiwiUHJvbWlzZSIsInJlc29sdmUiLCJhZGRfYXR0ciIsInRhc2tzIiwiUHRyIiwiTHN0IiwibG9hZCIsInZhbHVlIiwiZ2V0R3JvdXBUYXNrcyIsInZpc2l0eVR5cGUiLCJyZXMiLCJnZW5lcmF0ZUV2ZW50IiwiZXZlbnRzRGF0YSIsImNyZWF0ZVZpc2l0Q29udGV4dCIsImNvbnNvbGUiLCJsb2ciLCJsaW5rR3JvdXBUb1Zpc3RDb250ZXh0IiwiYWRkRXZlbnQiLCJjYXRjaCIsImVyciIsInN0YXRlIiwiZGF0ZSIsImdldEV2ZW50U3RhdGVOb2RlIiwiZXZlbnRTdGF0ZU5vZGUiLCJ2aXNpdCIsImZpbmQiLCJjb250ZXh0TmFtZSIsInJlamVjdCIsInZpc2l0Q29udGV4dElkIiwiaSIsImNoaWxkIiwiZXZlbnRTYXRlIiwic3BpbmFsVmlzaXRTZXJ2aWNlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQTs7QUFLQTs7QUFLQTs7OztBQUVBOztBQU1BOzs7Ozs7QUFFQTtBQUNBOztBQUVBLE1BQU1BLGtCQUFOLENBQXlCO0FBQ3ZCQyxnQkFBYztBQUNaLFNBQUtDLGtCQUFMLEdBQTBCLGdCQUExQjtBQUNBLFNBQUtDLFlBQUwsR0FBb0IsZUFBcEI7O0FBRUEsU0FBS0MsVUFBTCxHQUFrQixPQUFsQjs7QUFFQSxTQUFLQyxpQkFBTCxHQUF5QixtQkFBekI7QUFDQSxTQUFLQyxnQkFBTCxHQUF3QixrQkFBeEI7QUFDQSxTQUFLQyxjQUFMLEdBQXNCLGdCQUF0QjtBQUNBLFNBQUtDLGdCQUFMLEdBQXdCLGtCQUF4Qjs7QUFFQSxTQUFLQyxNQUFMLEdBQWNDLE9BQU9DLE1BQVAsQ0FBYyxDQUFDO0FBQ3pCQyxZQUFNLEtBQUtQLGlCQURjO0FBRXpCUSxZQUFNO0FBRm1CLEtBQUQsRUFJMUI7QUFDRUQsWUFBTSxLQUFLTixnQkFEYjtBQUVFTyxZQUFNO0FBRlIsS0FKMEIsRUFRMUI7QUFD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QTlCLENBQWhCOztBQU1BLGVBQU9NLGdEQUFtQmdDLFFBQW5CLENBQTRCWixPQUE1QixFQUNMVSxTQURLLEVBRUwsS0FBS2hDLHVCQUZBLEVBR0xtQix5REFISyxFQUd5QmYsSUFIekIsQ0FHOEIwRCxPQUFPO0FBQzFDLGNBQUlBLEdBQUosRUFBUyxPQUFPNUQsZ0RBQW1Ca0MsT0FBbkIsQ0FDZEosU0FEYyxDQUFQO0FBRVYsU0FOTSxDQUFQO0FBT0QsT0FkRCxNQWNPO0FBQ0wsZUFBT2xCLEVBQVA7QUFDRDtBQUVGLEtBakNJLENBQVA7QUFrQ0Q7O0FBbFhzQjs7QUF3WHpCLElBQUlzRSxxQkFBcUIsSUFBSXBHLGtCQUFKLEVBQXpCOztrQkFFZW9HLGtCIiwiZmlsZSI6ImluZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgU1BJTkFMX1JFTEFUSU9OX1BUUl9MU1RfVFlQRSxcbiAgU3BpbmFsR3JhcGhTZXJ2aWNlXG59IGZyb20gXCJzcGluYWwtZW52LXZpZXdlci1ncmFwaC1zZXJ2aWNlXCI7XG5cbmltcG9ydCB7XG4gIEVRVUlQTUVOVFNfVE9fRUxFTUVOVF9SRUxBVElPTixcbiAgRVFVSVBNRU5UU19HUk9VUFxufSBmcm9tIFwic3BpbmFsLWVudi12aWV3ZXItcm9vbS1tYW5hZ2VyL2pzL3NlcnZpY2VcIjtcblxuaW1wb3J0IFZpc2l0TW9kZWwgZnJvbSBcIi4vbW9kZWxzL3Zpc2l0Lm1vZGVsLmpzXCI7XG5cbmltcG9ydCB7XG4gIFB0cixcbiAgTHN0LFxuICBNb2RlbFxufSBmcm9tIFwic3BpbmFsLWNvcmUtY29ubmVjdG9yanNfdHlwZVwiO1xuXG5pbXBvcnQgbW9tZW50IGZyb20gXCJtb21lbnRcIjtcblxuLy8gaW1wb3J0IE9wZXJhdGlvbk1vZGVsIGZyb20gXCIuL29wZXJhdGlvbk1vZGVsXCI7XG4vLyBpbXBvcnQgVmlzaXRNb2RlbCBmcm9tIFwiLi92aXNpdE1vZGVsXCI7XG5cbmNsYXNzIFNwaW5hbFZpc2l0U2VydmljZSB7XG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHRoaXMuVklTSVRfQ09OVEVYVF9OQU1FID0gXCIudmlzaXRfY29udGV4dFwiO1xuICAgIHRoaXMuQ09OVEVYVF9UWVBFID0gXCJ2aXNpdF9jb250ZXh0XCI7XG5cbiAgICB0aGlzLlZJU0lUX1RZUEUgPSBcInZpc2l0XCI7XG5cbiAgICB0aGlzLk1BSU5URU5BTkNFX1ZJU0lUID0gXCJNQUlOVEVOQU5DRV9WSVNJVFwiO1xuICAgIHRoaXMuUkVHVUxBVE9SWV9WSVNJVCA9IFwiUkVHVUxBVE9SWV9WSVNJVFwiO1xuICAgIHRoaXMuU0VDVVJJVFlfVklTSVQgPSBcIlNFQ1VSSVRZX1ZJU0lUXCI7XG4gICAgdGhpcy5ESUFHTk9TVElDX1ZJU0lUID0gXCJESUFHTk9TVElDX1ZJU0lUXCI7XG5cbiAgICB0aGlzLlZJU0lUUyA9IE9iamVjdC5mcmVlemUoW3tcbiAgICAgICAgdHlwZTogdGhpcy5NQUlOVEVOQU5DRV9WSVNJVCxcbiAgICAgICAgbmFtZTogXCJNYWludGVuYWNlIHZpc2l0XCJcbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgIHR5cGU6IHRoaXMuUkVHVUxBVE9SWV9WSVNJVCxcbiAgICAgICAgbmFtZTogXCJSZWd1bGF0b3J5IHZpc2l0XCJcbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgIHR5cGU6IHRoaXMuU0VDVVJJVFlfVklTSVQsXG4gICAgICAgIG5hbWU6IFwiU2VjdXJpdHkgVmlzaXRcIlxuICAgICAgfSxcbiAgICAgIHtcbiAgICAgICAgdHlwZTogdGhpcy5ESUFHTk9TVElDX1ZJU0lULFxuICAgICAgICBuYW1lOiBcIkRpYWdub3N0aWMgdmlzaXRcIlxuICAgICAgfVxuICAgIF0pO1xuXG4gICAgLy9SRUxBVElPTlNcbiAgICAvLyB0aGlzLkNPTlRFWFRfVE9fVklTSVRfUkVMQVRJT04gPSBcImhhc1Zpc2l0XCI7XG4gICAgdGhpcy5HUk9VUF9UT19UQVNLID0gXCJoYXNUYXNrXCI7XG5cbiAgICB0aGlzLlZJU0lUX1RPX0dST1VQX1JFTEFUSU9OID0gXCJ2aXNpdEhhc0dyb3VwXCI7XG4gICAgdGhpcy5HUk9VUF9UT19FVkVOVF9SRUxBVElPTiA9IFwiaGFzRXZlbnRTdGF0ZVwiO1xuICAgIC8vIHRoaXMuVEFTS19UT19TVEFURSA9IFwiaGFzU3RhdGVcIjtcblxuICAgIC8vIHRoaXMuX2luaXQoKTtcbiAgfVxuXG4gIF9pbml0KCkge1xuICAgIFNwaW5hbEdyYXBoU2VydmljZS53YWl0Rm9ySW5pdGlhbGl6YXRpb24oKS50aGVuKCgpID0+IHtcbiAgICAgIGxldCBjb250ZXh0ID0gU3BpbmFsR3JhcGhTZXJ2aWNlLmdldENvbnRleHQodGhpc1xuICAgICAgICAuVklTSVRfQ09OVEVYVF9OQU1FKTtcblxuICAgICAgaWYgKHR5cGVvZiBjb250ZXh0ICE9PSBcInVuZGVmaW5lZFwiKSByZXR1cm47XG5cbiAgICAgIFNwaW5hbEdyYXBoU2VydmljZS5hZGRDb250ZXh0KFxuICAgICAgICB0aGlzLlZJU0lUX0NPTlRFWFRfTkFNRSxcbiAgICAgICAgdGhpcy5DT05URVhUX1RZUEUsXG4gICAgICAgIG5ldyBNb2RlbCh7XG4gICAgICAgICAgbmFtZTogdGhpcy5WSVNJVF9DT05URVhUX05BTUVcbiAgICAgICAgfSlcbiAgICAgICkudGhlbihjb250ZXh0Q3JlYXRlZCA9PiB7XG4gICAgICAgIGxldCBjb250ZXh0SWQgPSBjb250ZXh0Q3JlYXRlZC5nZXRJZCgpLmdldCgpO1xuXG4gICAgICAgIHRoaXMuVklTSVRTLmZvckVhY2goZWwgPT4ge1xuICAgICAgICAgIGxldCBub2RlSWQgPSBTcGluYWxHcmFwaFNlcnZpY2UuY3JlYXRlTm9kZSh7XG4gICAgICAgICAgICAgIG5hbWU6IGVsLm5hbWUsXG4gICAgICAgICAgICAgIHR5cGU6IGVsLnR5cGVcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBuZXcgTW9kZWwoe1xuICAgICAgICAgICAgICBuYW1lOiBlbFxuICAgICAgICAgICAgfSlcbiAgICAgICAgICApO1xuXG4gICAgICAgICAgU3BpbmFsR3JhcGhTZXJ2aWNlLmFkZENoaWxkSW5Db250ZXh0KFxuICAgICAgICAgICAgY29udGV4dElkLFxuICAgICAgICAgICAgbm9kZUlkLFxuICAgICAgICAgICAgY29udGV4dElkLFxuICAgICAgICAgICAgdGhpcy5DT05URVhUX1RPX1ZJU0lUX1JFTEFUSU9OLFxuICAgICAgICAgICAgU1BJTkFMX1JFTEFUSU9OX1BUUl9MU1RfVFlQRVxuICAgICAgICAgICk7XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuXG4gIGdldEFsbFZpc2l0cygpIHtcbiAgICByZXR1cm4gdGhpcy5WSVNJVFM7XG5cbiAgfVxuXG4gIGFkZFRhc2tPbkdyb3VwKFxuICAgIGdyb3VwSWQsXG4gICAgdGFza05hbWUsXG4gICAgcGVyaW9kaWNpdHlOdW1iZXIsXG4gICAgcGVyaW9kaWNpdHlNZXN1cmUsXG4gICAgdmlzaXROYW1lLFxuICAgIGludGVydmVudGlvbk51bWJlcixcbiAgICBpbnRlcnZlbnRpb25NZXN1cmUsXG4gICAgZGVzY3JpcHRpb25cbiAgKSB7XG5cbiAgICAvLyBsZXQgdmlzaXROYW1lID0gU3BpbmFsR3JhcGhTZXJ2aWNlLmdldEluZm8odmlzaXRJZCkudHlwZS5nZXQoKTtcblxuICAgIHJldHVybiBTcGluYWxHcmFwaFNlcnZpY2UuZ2V0Q2hpbGRyZW4oZ3JvdXBJZCwgW3RoaXMuR1JPVVBfVE9fVEFTS10pLnRoZW4oXG4gICAgICBjaGlsZHJlbiA9PiB7XG5cbiAgICAgICAgbGV0IGFyZ05vZGVJZDtcbiAgICAgICAgaWYgKGNoaWxkcmVuLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgIGFyZ05vZGVJZCA9IFNwaW5hbEdyYXBoU2VydmljZS5jcmVhdGVOb2RlKHtcbiAgICAgICAgICAgIG5hbWU6IFwibWFpbnRlbmFuY2VcIlxuICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgU3BpbmFsR3JhcGhTZXJ2aWNlLmFkZENoaWxkKFxuICAgICAgICAgICAgZ3JvdXBJZCxcbiAgICAgICAgICAgIGFyZ05vZGVJZCxcbiAgICAgICAgICAgIHRoaXMuR1JPVVBfVE9fVEFTSyxcbiAgICAgICAgICAgIFNQSU5BTF9SRUxBVElPTl9QVFJfTFNUX1RZUEVcbiAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IG5vZGUgPVxuICAgICAgICAgIHR5cGVvZiBhcmdOb2RlSWQgIT09IFwidW5kZWZpbmVkXCIgP1xuICAgICAgICAgIFNwaW5hbEdyYXBoU2VydmljZS5nZXRJbmZvKGFyZ05vZGVJZCkgOlxuICAgICAgICAgIGNoaWxkcmVuWzBdO1xuXG4gICAgICAgIHJldHVybiB0aGlzLmdldFB0clZhbHVlKG5vZGUsIHZpc2l0TmFtZSkudGhlbihsc3QgPT4ge1xuXG4gICAgICAgICAgLy8gbGV0IG5vZGVJZCA9IHRoaXMuX3ByZXBhcmVOb2RlKGdyb3VwSWQsIHRhc2tOYW1lLFxuICAgICAgICAgIC8vICAgcGVyaW9kaWNpdHlOdW1iZXIsXG4gICAgICAgICAgLy8gICBwZXJpb2RpY2l0eU1lc3VyZSxcbiAgICAgICAgICAvLyAgIHZpc2l0SWQsXG4gICAgICAgICAgLy8gICB2aXNpdE5hbWUsXG4gICAgICAgICAgLy8gICBpbnRlcnZlbnRpb25OdW1iZXIsXG4gICAgICAgICAgLy8gICBpbnRlcnZlbnRpb25NZXN1cmUsXG4gICAgICAgICAgLy8gICBkZXNjcmlwdGlvbik7XG5cbiAgICAgICAgICAvLyBTcGluYWxHcmFwaFNlcnZpY2UuYWRkQ2hpbGQodmlzaXRJZCwgbm9kZUlkLCB0aGlzXG4gICAgICAgICAgLy8gICAuVklTSVRfVE9fVEFTS19SRUxBVElPTiwgU1BJTkFMX1JFTEFUSU9OX1BUUl9MU1RfVFlQRSk7XG5cblxuXG4gICAgICAgICAgbGV0IHRhc2sgPSBuZXcgVmlzaXRNb2RlbCh0YXNrTmFtZSwgcGVyaW9kaWNpdHlOdW1iZXIsXG4gICAgICAgICAgICBwZXJpb2RpY2l0eU1lc3VyZSwgdmlzaXROYW1lLCBpbnRlcnZlbnRpb25OdW1iZXIsXG4gICAgICAgICAgICBpbnRlcnZlbnRpb25NZXN1cmUsIGRlc2NyaXB0aW9uKTtcblxuICAgICAgICAgIGxldCBub2RlSWQgPSBTcGluYWxHcmFwaFNlcnZpY2UuY3JlYXRlTm9kZSh7XG4gICAgICAgICAgICBncm91cElkOiBncm91cElkLFxuICAgICAgICAgICAgbmFtZTogdGFza05hbWUsXG4gICAgICAgICAgICBwZXJpb2RpY2l0eToge1xuICAgICAgICAgICAgICBudW1iZXI6IHRhc2sucGVyaW9kaWNpdHkubnVtYmVyLmdldCgpLFxuICAgICAgICAgICAgICBtZXN1cmU6IHRhc2sucGVyaW9kaWNpdHkubWVzdXJlLmdldCgpXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgaW50ZXJ2ZW50aW9uOiB7XG4gICAgICAgICAgICAgIG51bWJlcjogdGFzay5pbnRlcnZlbnRpb24ubnVtYmVyLmdldCgpLFxuICAgICAgICAgICAgICBtZXN1cmU6IHRhc2suaW50ZXJ2ZW50aW9uLm1lc3VyZS5nZXQoKVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHZpc2l0VHlwZTogdmlzaXROYW1lLFxuICAgICAgICAgICAgZGVzY3JpcHRpb246IGRlc2NyaXB0aW9uXG5cbiAgICAgICAgICB9LCB0YXNrKTtcblxuXG4gICAgICAgICAgbGV0IHJlYWxOb2RlID0gU3BpbmFsR3JhcGhTZXJ2aWNlLmdldFJlYWxOb2RlKG5vZGVJZCk7XG5cbiAgICAgICAgICBsc3QucHVzaChyZWFsTm9kZSk7XG5cbiAgICAgICAgICByZXR1cm4gcmVhbE5vZGUuaW5mbztcblxuICAgICAgICB9KVxuICAgICAgfVxuICAgICk7XG5cbiAgICAvLyBsZXQgdGFzayA9IG5ldyBWaXNpdE1vZGVsKHRhc2tOYW1lLCBiZWdpbkRhdGUsIHBlcmlvZGljaXR5TnVtYmVyLFxuICAgIC8vICAgcGVyaW9kaWNpdHlNZXN1cmUsXG4gICAgLy8gICB2aXNpdElkLCB2aXNpdE5hbWUpO1xuXG4gICAgLy8gbGV0IG5vZGVJZCA9IFNwaW5hbEdyYXBoU2VydmljZS5jcmVhdGVOb2RlKHtcbiAgICAvLyAgIG5hbWU6IHRhc2tOYW1lLFxuICAgIC8vICAgdHlwZTogXCJ0YXNrXCIsXG4gICAgLy8gICB2aXNpdElkOiB2aXNpdElkXG4gICAgLy8gfSwgdGFzayk7XG5cbiAgICAvLyAvLyByZXR1cm4gU3BpbmFsR3JhcGhTZXJ2aWNlLmFkZENoaWxkKGdyb3VwSWQsIG5vZGVJZCwgdGhpcy5HUk9VUF9UT19UQVNLLFxuICAgIC8vIC8vICAgU1BJTkFMX1JFTEFUSU9OX1BUUl9MU1RfVFlQRSkudGhlbihlbCA9PiB7XG4gICAgLy8gLy8gICBpZiAoZWwpIHtcbiAgICAvLyAvLyAgICAgdGhpcy5hZGRPcGVyYXRpb25zKGdyb3VwSWQsIG5vZGVJZCwgYmVnaW5EYXRlKTtcbiAgICAvLyAvLyAgICAgcmV0dXJuIHRhc2s7XG4gICAgLy8gLy8gICB9XG4gICAgLy8gLy8gfSlcbiAgfVxuXG4gIGdldFB0clZhbHVlKG5vZGUsIHB0ck5hbWUpIHtcbiAgICBsZXQgcmVhbE5vZGUgPSBTcGluYWxHcmFwaFNlcnZpY2UuZ2V0UmVhbE5vZGUobm9kZS5pZC5nZXQoKSk7XG5cbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICAgIGlmICghcmVhbE5vZGUuaW5mb1twdHJOYW1lXSkge1xuICAgICAgICByZWFsTm9kZS5pbmZvLmFkZF9hdHRyKHB0ck5hbWUsIHtcbiAgICAgICAgICB0YXNrczogbmV3IFB0cihuZXcgTHN0KCkpXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICByZWFsTm9kZS5pbmZvW3B0ck5hbWVdLnRhc2tzLmxvYWQoKHZhbHVlKSA9PiB7XG4gICAgICAgIHJldHVybiByZXNvbHZlKHZhbHVlKTtcbiAgICAgIH0pXG4gICAgfSlcblxuXG4gIH1cblxuICBnZXRHcm91cFRhc2tzKGdyb3VwSWQsIHZpc2l0eVR5cGUpIHtcbiAgICByZXR1cm4gU3BpbmFsR3JhcGhTZXJ2aWNlLmdldENoaWxkcmVuKGdyb3VwSWQsIFt0aGlzLkdST1VQX1RPX1RBU0tdKS50aGVuKFxuICAgICAgcmVzID0+IHtcbiAgICAgICAgbGV0IG5vZGVJZDtcbiAgICAgICAgaWYgKHJlcy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICBub2RlSWQgPSBTcGluYWxHcmFwaFNlcnZpY2UuY3JlYXRlTm9kZSh7XG4gICAgICAgICAgICBuYW1lOiBcIm1haW50ZW5hbmNlXCJcbiAgICAgICAgICB9KTtcblxuICAgICAgICAgIFNwaW5hbEdyYXBoU2VydmljZS5hZGRDaGlsZChcbiAgICAgICAgICAgIGdyb3VwSWQsXG4gICAgICAgICAgICBub2RlSWQsXG4gICAgICAgICAgICB0aGlzLkdST1VQX1RPX1RBU0ssXG4gICAgICAgICAgICBTUElOQUxfUkVMQVRJT05fUFRSX0xTVF9UWVBFXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBub2RlID1cbiAgICAgICAgICB0eXBlb2Ygbm9kZUlkICE9PSBcInVuZGVmaW5lZFwiID9cbiAgICAgICAgICBTcGluYWxHcmFwaFNlcnZpY2UuZ2V0SW5mbyhub2RlSWQpIDpcbiAgICAgICAgICByZXNbMF07XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0UHRyVmFsdWUobm9kZSwgdmlzaXR5VHlwZSk7XG4gICAgICB9KTtcblxuICB9XG5cblxuXG4gIGdlbmVyYXRlRXZlbnQodmlzaXRUeXBlLCBncm91cElkLCBldmVudHNEYXRhKSB7XG5cblxuICAgIC8vIGNvbnNvbGUubG9nKFwiaW5zaWRlIGpzXCIsIHZpc2l0VHlwZSwgZ3JvdXBJZCwgdGFza05hbWUsIGJlZ2luRGF0ZSwgZW5kRGF0ZSxcbiAgICAvLyAgIHBlcmlvZGljaXR5TnVtYmVyLCBwZXJpb2RpY2l0eU1lc3VyZSk7XG5cblxuICAgIHJldHVybiB0aGlzLmNyZWF0ZVZpc2l0Q29udGV4dCh2aXNpdFR5cGUpXG4gICAgICAudGhlbihlbCA9PiB7XG4gICAgICAgIGNvbnNvbGUubG9nKFwiZWxcIiwgZWwpO1xuICAgICAgICByZXR1cm4gdGhpcy5saW5rR3JvdXBUb1Zpc3RDb250ZXh0KGVsLmlkLmdldCgpLCBncm91cElkKS50aGVuKFxuICAgICAgICAgIHJlcyA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcInJlc1wiLCByZXMpO1xuICAgICAgICAgICAgaWYgKHJlcykge1xuICAgICAgICAgICAgICB0aGlzLmFkZEV2ZW50KGdyb3VwSWQsIFwiZMOpY2xhcsOpXCIpO1xuICAgICAgICAgICAgICB0aGlzLmFkZEV2ZW50KGdyb3VwSWQsIFwiRW5jb3Vyc1wiKTtcbiAgICAgICAgICAgICAgdGhpcy5hZGRFdmVudChncm91cElkLCBcIkVmZmVjdHXDqVwiKTtcbiAgICAgICAgICAgICAgdGhpcy5hZGRFdmVudChncm91cElkLCBcImTDqWNsYXLDqVwiKTtcbiAgICAgICAgICAgICAgdGhpcy5hZGRFdmVudChncm91cElkLCBcIkVuY291cnNcIik7XG4gICAgICAgICAgICAgIHRoaXMuYWRkRXZlbnQoZ3JvdXBJZCwgXCJFZmZlY3R1w6lcIik7XG4gICAgICAgICAgICAgIHRoaXMuYWRkRXZlbnQoZ3JvdXBJZCwgXCJkw6ljbGFyw6lcIik7XG4gICAgICAgICAgICAgIHRoaXMuYWRkRXZlbnQoZ3JvdXBJZCwgXCJFbmNvdXJzXCIpO1xuICAgICAgICAgICAgICB0aGlzLmFkZEV2ZW50KGdyb3VwSWQsIFwiRWZmZWN0dcOpXCIpO1xuICAgICAgICAgICAgICB0aGlzLmFkZEV2ZW50KGdyb3VwSWQsIFwiZMOpY2xhcsOpXCIpO1xuICAgICAgICAgICAgICB0aGlzLmFkZEV2ZW50KGdyb3VwSWQsIFwiRW5jb3Vyc1wiKTtcbiAgICAgICAgICAgICAgdGhpcy5hZGRFdmVudChncm91cElkLCBcIkVmZmVjdHXDqVwiKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KTtcbiAgICAgIH0pXG4gICAgICAuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgY29uc29sZS5sb2coZXJyKTtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShlcnIpO1xuICAgICAgfSlcblxuXG4gIH1cblxuXG4gIGFkZEV2ZW50KGdyb3VwSWQsIHN0YXRlLCBuYW1lLCBkYXRlKSB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0RXZlbnRTdGF0ZU5vZGUoZ3JvdXBJZCwgc3RhdGUpLnRoZW4oZXZlbnRTdGF0ZU5vZGUgPT4ge1xuICAgICAgY29uc29sZS5sb2coXCJldmVudFN0YXRlTm9kZVwiLCBldmVudFN0YXRlTm9kZSk7XG4gICAgfSlcbiAgfVxuXG5cblxuXG4gIGNyZWF0ZVZpc2l0Q29udGV4dCh2aXNpdFR5cGUpIHtcblxuICAgIGxldCB2aXNpdCA9IHRoaXMuVklTSVRTLmZpbmQoZWwgPT4ge1xuICAgICAgcmV0dXJuIGVsLnR5cGUgPT09IHZpc2l0VHlwZTtcbiAgICB9KVxuXG4gICAgaWYgKHR5cGVvZiB2aXNpdCAhPT0gXCJ1bmRlZmluZWRcIikge1xuICAgICAgY29uc3QgY29udGV4dE5hbWUgPSBgLiR7dmlzaXQubmFtZX1gO1xuXG4gICAgICBsZXQgY29udGV4dCA9IFNwaW5hbEdyYXBoU2VydmljZS5nZXRDb250ZXh0KGNvbnRleHROYW1lKTtcbiAgICAgIGlmICh0eXBlb2YgY29udGV4dCAhPT0gXCJ1bmRlZmluZWRcIikgcmV0dXJuIFByb21pc2UucmVzb2x2ZShjb250ZXh0XG4gICAgICAgIC5pbmZvKTtcblxuICAgICAgcmV0dXJuIFNwaW5hbEdyYXBoU2VydmljZS5hZGRDb250ZXh0KGNvbnRleHROYW1lLCB2aXNpdFR5cGUsIG5ldyBNb2RlbCh7XG4gICAgICAgIG5hbWU6IHRoaXMuVklTSVRfQ09OVEVYVF9OQU1FXG4gICAgICB9KSkudGhlbihjb250ZXh0Q3JlYXRlZCA9PiB7XG4gICAgICAgIHJldHVybiBjb250ZXh0Q3JlYXRlZC5pbmZvO1xuICAgICAgfSk7XG5cbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KFwidmlzaXROb3RGb3VuZFwiKTtcbiAgICB9XG5cbiAgfVxuXG5cbiAgbGlua0dyb3VwVG9WaXN0Q29udGV4dCh2aXNpdENvbnRleHRJZCwgZ3JvdXBJZCkge1xuICAgIHJldHVybiBTcGluYWxHcmFwaFNlcnZpY2UuZ2V0Q2hpbGRyZW4odmlzaXRDb250ZXh0SWQsIFt0aGlzXG4gICAgICAuVklTSVRfVE9fR1JPVVBfUkVMQVRJT05cbiAgICBdKS50aGVuKGNoaWxkcmVuID0+IHtcbiAgICAgIGNvbnNvbGUubG9nKFwiY2hpbGRyZW5cIiwgY2hpbGRyZW4pO1xuXG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGNvbnN0IGNoaWxkID0gY2hpbGRyZW5baV0uaWQuZ2V0KCk7XG4gICAgICAgIGlmIChjaGlsZCA9PT0gZ3JvdXBJZCkgcmV0dXJuIHRydWU7XG4gICAgICB9XG5cbiAgICB9KS50aGVuKGVsID0+IHtcblxuICAgICAgY29uc29sZS5sb2coXCJlbDIyMjJcIiwgZWwpXG5cbiAgICAgIGlmICh0eXBlb2YgZWwgPT09IFwidW5kZWZpbmVkXCIpIHtcbiAgICAgICAgY29uc29sZS5sb2coXCJ5ZXMgZWwyMjIgaXMgdW5kZWZpbmVkXCIsIHZpc2l0Q29udGV4dElkLCBncm91cElkKVxuICAgICAgICByZXR1cm4gU3BpbmFsR3JhcGhTZXJ2aWNlLmFkZENoaWxkKHZpc2l0Q29udGV4dElkLCBncm91cElkLCB0aGlzXG4gICAgICAgICAgLlZJU0lUX1RPX0dST1VQX1JFTEFUSU9OLCBTUElOQUxfUkVMQVRJT05fUFRSX0xTVF9UWVBFKVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc29sZS5sb2coXCJub2RlIG5vdCB1bmRlZmluZWRcIik7XG5cbiAgICAgICAgcmV0dXJuIGVsO1xuICAgICAgfVxuXG4gICAgfSlcbiAgfVxuXG5cbiAgZ2V0RXZlbnRTdGF0ZU5vZGUoZ3JvdXBJZCwgZXZlbnRTYXRlKSB7XG4gICAgcmV0dXJuIFNwaW5hbEdyYXBoU2VydmljZS5nZXRDaGlsZHJlbihncm91cElkLCBbdGhpc1xuICAgICAgICAuR1JPVVBfVE9fRVZFTlRfUkVMQVRJT05cbiAgICAgIF0pXG4gICAgICAudGhlbihjaGlsZHJlbiA9PiB7XG5cbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjaGlsZHJlbi5sZW5ndGg7IGkrKykge1xuICAgICAgICAgIGNvbnN0IG5hbWUgPSBjaGlsZHJlbltpXS5uYW1lLmdldCgpO1xuXG4gICAgICAgICAgaWYgKG5hbWUgPT09IGV2ZW50U2F0ZSkge1xuICAgICAgICAgICAgcmV0dXJuIGNoaWxkcmVuW2ldO1xuICAgICAgICAgIH1cblxuICAgICAgICB9XG5cbiAgICAgIH0pLnRoZW4oZWwgPT4ge1xuICAgICAgICBpZiAodHlwZW9mIGVsID09PSBcInVuZGVmaW5lZFwiKSB7XG4gICAgICAgICAgbGV0IGFyZ05vZGVJZCA9IFNwaW5hbEdyYXBoU2VydmljZS5jcmVhdGVOb2RlKHtcbiAgICAgICAgICAgIG5hbWU6IGV2ZW50U2F0ZSxcbiAgICAgICAgICAgIHN0YXRlOiBldmVudFNhdGUsXG4gICAgICAgICAgICB0eXBlOiBcIkV2ZW50U3RhdGVcIlxuICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgcmV0dXJuIFNwaW5hbEdyYXBoU2VydmljZS5hZGRDaGlsZChncm91cElkLFxuICAgICAgICAgICAgYXJnTm9kZUlkLFxuICAgICAgICAgICAgdGhpcy5HUk9VUF9UT19FVkVOVF9SRUxBVElPTixcbiAgICAgICAgICAgIFNQSU5BTF9SRUxBVElPTl9QVFJfTFNUX1RZUEUpLnRoZW4ocmVzID0+IHtcbiAgICAgICAgICAgIGlmIChyZXMpIHJldHVybiBTcGluYWxHcmFwaFNlcnZpY2UuZ2V0SW5mbyhcbiAgICAgICAgICAgICAgYXJnTm9kZUlkKTtcbiAgICAgICAgICB9KVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiBlbDtcbiAgICAgICAgfVxuXG4gICAgICB9KVxuICB9XG5cblxuXG59XG5cbmxldCBzcGluYWxWaXNpdFNlcnZpY2UgPSBuZXcgU3BpbmFsVmlzaXRTZXJ2aWNlKCk7XG5cbmV4cG9ydCBkZWZhdWx0IHNwaW5hbFZpc2l0U2VydmljZTsiXX0=