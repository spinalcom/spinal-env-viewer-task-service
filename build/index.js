"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _spinalEnvViewerGraphService = require("spinal-env-viewer-graph-service");

var _service = require("spinal-env-viewer-room-manager/js/service");

var _visitModel = require("./models/visit.model.js");

var _visitModel2 = _interopRequireDefault(_visitModel);

var _eventModel = require("./models/event.model.js");

var _eventModel2 = _interopRequireDefault(_eventModel);

var _taskModel = require("./models/task.model.js");

var _taskModel2 = _interopRequireDefault(_taskModel);

var _spinalCoreConnectorjs_type = require("spinal-core-connectorjs_type");

var _moment = require("moment");

var _moment2 = _interopRequireDefault(_moment);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _asyncToGenerator(fn) { return function () { var gen = fn.apply(this, arguments); return new Promise(function (resolve, reject) { function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { return Promise.resolve(value).then(function (value) { step("next", value); }, function (err) { step("throw", err); }); } } return step("next"); }); }; }

class SpinalVisitService {
  constructor() {
    this.VISIT_CONTEXT_NAME = ".visit_context";
    this.CONTEXT_TYPE = "visit_context";

    this.VISIT_TYPE = "visit";

    this.MAINTENANCE_VISIT = "MAINTENANCE_VISIT";
    this.REGULATORY_VISIT = "REGULATORY_VISIT";
    this.SECURITY_VISIT = "SECURITY_VISIT";
    this.DIAGNOSTIC_VISIT = "DIAGNOSTIC_VISIT";

    this.EVENT_STATES = Object.freeze({
      declared: "déclaré",
      processing: "encours",
      done: "éffectué"
    });

    this.VISITS = Object.freeze([{
      type: this.MAINTENANCE_VISIT,
      name: "Maintenace visit"
    }, {
      type: this.REGULATORY_VISIT,
      name: "Regulatory visit"
    }, {
      type: this.SECURITY_VISIT,
      name: "Security Visit"
    }, {
      type: this.DIAGNOSTIC_VISIT,
      name: "Diagnostic visit"
    }]);

    this.MAINTENANCE_VISIT_EVENT_STATE_RELATION = "maintenanceVisithasEventState";

    this.REGULATORY_VISIT_EVENT_STATE_RELATION = "regulatoryVisithasEventState";

    this.SECURITY_VISIT_EVENT_STATE_RELATION = "securityVisithasEventState";

    this.DIAGNOSTIC_VISIT_EVENT_STATE_RELATION = "diagnosticVisithasEventState";

    this.GROUP_TO_TASK = "hasVisit";

    this.VISIT_TO_EVENT_RELATION = "visitHasEvent";

    this.VISIT_TYPE_TO_GROUP_RELATION = "visitHasGroup";
    this.EVENT_STATE_TO_EVENT_RELATION = "hasEvent";
    this.EVENT_TO_TASK_RELATION = "hasTask";
  }

  getAllVisits() {
    return this.VISITS;
  }

  addVisitOnGroup(groupId, visitName, periodicityNumber, periodicityMesure, visitType, interventionNumber, interventionMesure, description) {

    // let visitType = SpinalGraphService.getInfo(visitId).type.get();

    return _spinalEnvViewerGraphService.SpinalGraphService.getChildren(groupId, [this.GROUP_TO_TASK]).then(children => {

      let argNodeId;
      if (children.length === 0) {
        argNodeId = _spinalEnvViewerGraphService.SpinalGraphService.createNode({
          name: "maintenance"
        });

        _spinalEnvViewerGraphService.SpinalGraphService.addChild(groupId, argNodeId, this.GROUP_TO_TASK, _spinalEnvViewerGraphService.SPINAL_RELATION_PTR_LST_TYPE);
      }

      let node = typeof argNodeId !== "undefined" ? _spinalEnvViewerGraphService.SpinalGraphService.getInfo(argNodeId) : children[0];

      return this.getPtrValue(node, visitType).then(lst => {

        // let nodeId = this._prepareNode(groupId, visitName,
        //   periodicityNumber,
        //   periodicityMesure,
        //   visitId,
        //   visitType,
        //   interventionNumber,
        //   interventionMesure,
        //   description);

        // SpinalGraphService.addChild(visitId, nodeId, this
        //   .VISIT_TO_TASK_RELATION, SPINAL_RELATION_PTR_LST_TYPE);


        let task = new _visitModel2.default(visitName, periodicityNumber, periodicityMesure, visitType, interventionNumber, interventionMesure, description);

        let nodeId = _spinalEnvViewerGraphService.SpinalGraphService.createNode({
          groupId: groupId,
          name: visitName,
          periodicity: {
            number: task.periodicity.number.get(),
            mesure: task.periodicity.mesure.get()
          },
          intervention: {
            number: task.intervention.number.get(),
            mesure: task.intervention.mesure.get()
          },
          visitType: visitType,
          description: description

        }, task);

        let realNode = _spinalEnvViewerGraphService.SpinalGraphService.getRealNode(nodeId);

        lst.push(realNode);

        return realNode.info;
      });
    });

    // let task = new VisitModel(visitName, beginDate, periodicityNumber,
    //   periodicityMesure,
    //   visitId, visitName);

    // let nodeId = SpinalGraphService.createNode({
    //   name: taskName,
    //   type: "task",
    //   visitId: visitId
    // }, task);

    // // return SpinalGraphService.addChild(groupId, nodeId, this.GROUP_TO_TASK,
    // //   SPINAL_RELATION_PTR_LST_TYPE).then(el => {
    // //   if (el) {
    // //     this.addOperations(groupId, nodeId, beginDate);
    // //     return task;
    // //   }
    // // })
  }

  getPtrValue(node, ptrName) {
    let realNode = _spinalEnvViewerGraphService.SpinalGraphService.getRealNode(node.id.get());

    return new Promise(resolve => {
      if (!realNode.info[ptrName]) {
        realNode.info.add_attr(ptrName, {
          tasks: new _spinalCoreConnectorjs_type.Ptr(new _spinalCoreConnectorjs_type.Lst())
        });
      }

      realNode.info[ptrName].tasks.load(value => {
        return resolve(value);
      });
    });
  }

  getGroupVisits(groupId, visityType) {
    return _spinalEnvViewerGraphService.SpinalGraphService.getChildren(groupId, [this.GROUP_TO_TASK]).then(res => {
      let nodeId;
      if (res.length === 0) {
        nodeId = _spinalEnvViewerGraphService.SpinalGraphService.createNode({
          name: "maintenance"
        });

        _spinalEnvViewerGraphService.SpinalGraphService.addChild(groupId, nodeId, this.GROUP_TO_TASK, _spinalEnvViewerGraphService.SPINAL_RELATION_PTR_LST_TYPE);
      }

      let node = typeof nodeId !== "undefined" ? _spinalEnvViewerGraphService.SpinalGraphService.getInfo(nodeId) : res[0];

      return this.getPtrValue(node, visityType);
    });
  }

  generateEvent(visitType, groupId, beginDate, endDate, eventsData) {

    return this.createVisitContext(visitType).then(el => {

      return this.linkGroupToVistContext(el.id.get(), groupId).then(res => {

        if (res) {
          this.getEventStateNode(el.id.get(), groupId, this.EVENT_STATES.declared).then(stateNode => {

            let id = stateNode.id.get();

            eventsData.forEach(eventInfo => {
              let eventsDate = this._getDate(beginDate, endDate, eventInfo.periodNumber, eventInfo.periodMesure);

              eventsDate.forEach(date => {
                this.addEvent(el.id.get(), groupId, id, eventInfo, `Event_${eventInfo.name}_${this._formatDate(date)}`, new Date(date).getTime());
              });
            });
          });
        }
      });
    }).catch(err => {
      console.log(err);
      return Promise.resolve(err);
    });
  }

  addEvent(visitTypeContextId, groupId, stateId, visitInfo, name, date) {

    let state = _spinalEnvViewerGraphService.SpinalGraphService.getInfo(stateId).name.get();

    let event = new _eventModel2.default(name, date, state, groupId);

    let eventNodeId = _spinalEnvViewerGraphService.SpinalGraphService.createNode({
      name: name,
      date: date,
      state: state,
      groupId: groupId,
      visitId: visitInfo.id
    }, event);

    return _spinalEnvViewerGraphService.SpinalGraphService.addChildInContext(stateId, eventNodeId, visitTypeContextId, this.EVENT_STATE_TO_EVENT_RELATION, _spinalEnvViewerGraphService.SPINAL_RELATION_PTR_LST_TYPE).then(el => {
      if (el) return eventNodeId;
    }).then(eventId => {

      if (typeof eventId !== "undefined") {
        return _spinalEnvViewerGraphService.SpinalGraphService.getChildren(groupId, [_service.EQUIPMENTS_TO_ELEMENT_RELATION]).then(children => {

          children.map(child => {
            let name = `${visitInfo.name}__${child.name.get()}`;
            let task = new _taskModel2.default(name, child.dbid.get(), child.bimFileId.get(), visitInfo.name, 0);

            let taskId = _spinalEnvViewerGraphService.SpinalGraphService.createNode({
              name: name,
              dbId: child.dbid.get(),
              bimFileId: child.bimFileId.get(),
              taskName: visitInfo.name,
              visitId: visitInfo.id,
              state: task.state.get()
            }, task);

            return Promise.all([_spinalEnvViewerGraphService.SpinalGraphService.addChildInContext(eventId, taskId, visitTypeContextId, this.EVENT_TO_TASK_RELATION, _spinalEnvViewerGraphService.SPINAL_RELATION_PTR_LST_TYPE), _spinalEnvViewerGraphService.SpinalGraphService.addChild(visitInfo.id, eventId, this.VISIT_TO_EVENT_RELATION, _spinalEnvViewerGraphService.SPINAL_RELATION_PTR_LST_TYPE)]);
          });
        });
      }
    });
  }

  createVisitContext(visitType) {

    let visit = this.VISITS.find(el => {
      return el.type === visitType;
    });

    if (typeof visit !== "undefined") {
      const contextName = `${visit.name}`;

      let context = _spinalEnvViewerGraphService.SpinalGraphService.getContext(contextName);
      if (typeof context !== "undefined") return Promise.resolve(context.info);

      return _spinalEnvViewerGraphService.SpinalGraphService.addContext(contextName, visitType, new _spinalCoreConnectorjs_type.Model({
        name: this.VISIT_CONTEXT_NAME
      })).then(contextCreated => {
        return contextCreated.info;
      });
    } else {
      return Promise.reject("visitNotFound");
    }
  }

  linkGroupToVistContext(visitContextId, groupId) {
    var _this = this;

    return _spinalEnvViewerGraphService.SpinalGraphService.getChildren(visitContextId, [this.VISIT_TYPE_TO_GROUP_RELATION]).then(children => {

      for (let i = 0; i < children.length; i++) {
        const child = children[i].id.get();
        if (child === groupId) return true;
      }
    }).then(el => {

      if (typeof el === "undefined") {

        return _spinalEnvViewerGraphService.SpinalGraphService.addChildInContext(visitContextId, groupId, visitContextId, this.VISIT_TYPE_TO_GROUP_RELATION, _spinalEnvViewerGraphService.SPINAL_RELATION_PTR_LST_TYPE).then((() => {
          var _ref = _asyncToGenerator(function* (res) {

            if (res) {
              yield _this.getEventStateNode(visitContextId, groupId, _this.EVENT_STATES.processing);
              yield _this.getEventStateNode(visitContextId, groupId, _this.EVENT_STATES.done);
            }

            return res;
          });

          return function (_x) {
            return _ref.apply(this, arguments);
          };
        })());
      } else {

        return el;
      }
    });
  }

  getEventStateNode(visitContextId, groupId, eventSate) {

    let contextType = _spinalEnvViewerGraphService.SpinalGraphService.getInfo(visitContextId).type.get();
    let relationName;

    switch (contextType) {
      case this.MAINTENANCE_VISIT:
        relationName = this.MAINTENANCE_VISIT_EVENT_STATE_RELATION;
        break;
      case this.SECURITY_VISIT:
        relationName = this.SECURITY_VISIT_EVENT_STATE_RELATION;
        break;
      case this.DIAGNOSTIC_VISIT:
        relationName = this.DIAGNOSTIC_VISIT_EVENT_STATE_RELATION;
        break;
      case this.REGULATORY_VISIT:
        relationName = this.REGULATORY_VISIT_EVENT_STATE_RELATION;
        break;

    }

    return _spinalEnvViewerGraphService.SpinalGraphService.getChildren(groupId, [relationName]).then(children => {

      for (let i = 0; i < children.length; i++) {
        const name = children[i].name.get();

        if (name === eventSate) {
          return children[i];
        }
      }
    }).then(el => {
      if (typeof el === "undefined") {
        let argNodeId = _spinalEnvViewerGraphService.SpinalGraphService.createNode({
          name: eventSate,
          state: eventSate,
          type: "EventState"
        });

        return _spinalEnvViewerGraphService.SpinalGraphService.addChildInContext(groupId, argNodeId, visitContextId, relationName, _spinalEnvViewerGraphService.SPINAL_RELATION_PTR_LST_TYPE).then(res => {
          if (res) return _spinalEnvViewerGraphService.SpinalGraphService.getInfo(argNodeId);
        });
      } else {
        return el;
      }
    });
  }

  ////////////////////////////////////////////////////////////////////////
  //                            PRIVATES                                //
  ////////////////////////////////////////////////////////////////////////


  _getDate(beginDate, endDate, periodNumber, periodMesure) {

    let mesure = ['days', 'weeks', 'months', 'years'][periodMesure];

    let eventsDate = [];

    let date = (0, _moment2.default)(beginDate);
    let end = (0, _moment2.default)(endDate);

    while (end.diff(date) >= 0) {
      eventsDate.push(date.toDate());

      date = date.add(periodNumber, mesure);
    }

    return eventsDate;
  }

  _formatDate(argDate) {
    let date = new Date(argDate);

    return `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`;
  }

}

let spinalVisitService = new SpinalVisitService();

exports.default = spinalVisitService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJTcGluYWxWaXNpdFNlcnZpY2UiLCJjb25zdHJ1Y3RvciIsIlZJU0lUX0NPTlRFWFRfTkFNRSIsIkNPTlRFWFRfVFlQRSIsIlZJU0lUX1RZUEUiLCJNQUlOVEVOQU5DRV9WSVNJVCIsIlJFR1VMQVRPUllfVklTSVQiLCJTRUNVUklUWV9WSVNJVCIsIkRJQUdOT1NUSUNfVklTSVQiLCJFVkVOVF9TVEFURVMiLCJPYmplY3QiLCJmcmVlemUiLCJkZWNsYXJlZCIsInByb2Nlc3NpbmciLCJkb25lIiwiVklTSVRTIiwidHlwZSIsIm5hbWUiLCJNQUlOVEVOQU5DRV9WSVNJVF9FVkVOVF9TVEFURV9SRUxBVElPTiIsIlJFR1VMQVRPUllfVklTSVRfRVZFTlRfU1RBVEVfUkVMQVRJT04iLCJTRUNVUklUWV9WSVNJVF9FVkVOVF9TVEFURV9SRUxBVElPTiIsIkRJQUdOT1NUSUNfVklTSVRfRVZFTlRfU1RBVEVfUkVMQVRJT04iLCJHUk9VUF9UT19UQVNLIiwiVklTSVRfVE9fRVZFTlRfUkVMQVRJT04iLCJWSVNJVF9UWVBFX1RPX0dST1VQX1JFTEFUSU9OIiwiRVZFTlRfU1RBVEVfVE9fRVZFTlRfUkVMQVRJT04iLCJFVkVOVF9UT19UQVNLX1JFTEFUSU9OIiwiZ2V0QWxsVmlzaXRzIiwiYWRkVmlzaXRPbkdyb3VwIiwiZ3JvdXBJZCIsInZpc2l0TmFtZSIsInBlcmlvZGljaXR5TnVtYmVyIiwicGVyaW9kaWNpdHlNZXN1cmUiLCJ2aXNpdFR5cGUiLCJpbnRlcnZlbnRpb25OdW1iZXIiLCJpbnRlcnZlbnRpb25NZXN1cmUiLCJkZXNjcmlwdGlvbiIsIlNwaW5hbEdyYXBoU2VydmljZSIsImdldENoaWxkcmVuIiwidGhlbiIsImNoaWxkcmVuIiwiYXJnTm9kZUlkIiwibGVuZ3RoIiwiY3JlYXRlTm9kZSIsImFkZENoaWxkIiwiU1BJTkFMX1JFTEFUSU9OX1BUUl9MU1RfVFlQRSIsIm5vZGUiLCJnZXRJbmZvIiwiZ2V0UHRyVmFsdWUiLCJsc3QiLCJ0YXNrIiwiVmlzaXRNb2RlbCIsIm5vZGVJZCIsInBlcmlvZGljaXR5IiwibnVtYmVyIiwiZ2V0IiwibWVzdXJlIiwiaW50ZXJ2ZW50aW9uIiwicmVhbE5vZGUiLCJnZXRSZWFsTm9kZSIsInB1c2giLCJpbmZvIiwicHRyTmFtZSIsImlkIiwiUHJvbWlzZSIsInJlc29sdmUiLCJhZGRfYXR0ciIsInRhc2tzIiwiUHRyIiwiTHN0IiwibG9hZCIsInZhbHVlIiwiZ2V0R3JvdXBWaXNpdHMiLCJ2aXNpdHlUeXBlIiwicmVzIiwiZ2VuZXJhdGVFdmVudCIsImJlZ2luRGF0ZSIsImVuZERhdGUiLCJldmVudHNEYXRhIiwiY3JlYXRlVmlzaXRDb250ZXh0IiwiZWwiLCJsaW5rR3JvdXBUb1Zpc3RDb250ZXh0IiwiZ2V0RXZlbnRTdGF0ZU5vZGUiLCJzdGF0ZU5vZGUiLCJmb3JFYWNoIiwiZXZlbnRJbmZvIiwiZXZlbnRzRGF0ZSIsIl9nZXREYXRlIiwicGVyaW9kTnVtYmVyIiwicGVyaW9kTWVzdXJlIiwiZGF0ZSIsImFkZEV2ZW50IiwiX2Zvcm1hdERhdGUiLCJEYXRlIiwiZ2V0VGltZSIsImNhdGNoIiwiZXJyIiwiY29uc29sZSIsImxvZyIsInZpc2l0VHlwZUNvbnRleHRJZCIsInN0YXRlSWQiLCJ2aXNpdEluZm8iLCJzdGF0ZSIsImV2ZW50IiwiRXZlbnRNb2RlbCIsImV2ZW50Tm9kZUlkIiwidmlzaXRJZCIsImFkZENoaWxkSW5Db250ZXh0IiwiZXZlbnRJZCIsIkVRVUlQTUVOVFNfVE9fRUxFTUVOVF9SRUxBVElPTiIsIm1hcCIsImNoaWxkIiwiVGFza01vZGVsIiwiZGJpZCIsImJpbUZpbGVJZCIsInRhc2tJZCIsImRiSWQiLCJ0YXNrTmFtZSIsImFsbCIsInZpc2l0IiwiZmluZCIsImNvbnRleHROYW1lIiwiY29udGV4dCIsImdldENvbnRleHQiLCJhZGRDb250ZXh0IiwiTW9kZWwiLCJjb250ZXh0Q3JlYXRlZCIsInJlamVjdCIsInZpc2l0Q29udGV4dElkIiwiaSIsImV2ZW50U2F0ZSIsImNvbnRleHRUeXBlIiwicmVsYXRpb25OYW1lIiwiZW5kIiwiZGlmZiIsInRvRGF0ZSIsImFkZCIsImFyZ0RhdGUiLCJnZXREYXRlIiwiZ2V0TW9udGgiLCJnZXRGdWxsWWVhciIsInNwaW5hbFZpc2l0U2VydmljZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUE7O0FBS0E7O0FBSUE7Ozs7QUFDQTs7OztBQUNBOzs7O0FBRUE7O0FBTUE7Ozs7Ozs7O0FBR0EsTUFBTUEsa0JBQU4sQ0FBeUI7QUFDdkJDLGdCQUFjO0FBQ1osU0FBS0Msa0JBQUwsR0FBMEIsZ0JBQTFCO0FBQ0EsU0FBS0MsWUFBTCxHQUFvQixlQUFwQjs7QUFFQSxTQUFLQyxVQUFMLEdBQWtCLE9BQWxCOztBQUVBLFNBQUtDLGlCQUFMLEdBQXlCLG1CQUF6QjtBQUNBLFNBQUtDLGdCQUFMLEdBQXdCLGtCQUF4QjtBQUNBLFNBQUtDLGNBQUwsR0FBc0IsZ0JBQXRCO0FBQ0EsU0FBS0MsZ0JBQUwsR0FBd0Isa0JBQXhCOztBQUdBLFNBQUtDLFlBQUwsR0FBb0JDLE9BQU9DLE1BQVAsQ0FBYztBQUNoQ0MsZ0JBQVUsU0FEc0I7QUFFaENDLGtCQUFZLFNBRm9CO0FBR2hDQyxZQUFNO0FBSDBCLEtBQWQsQ0FBcEI7O0FBTUEsU0FBS0MsTUFBTCxHQUFjTCxPQUFPQyxNQUFQLENBQWMsQ0FBQztBQUN6QkssWUFBTSxLQUFLWCxpQkFEYztBQUV6QlksWUFBTTtBQUZtQixLQUFELEVBSTFCO0FBQ0VELFlBQU0sS0FBS1YsZ0JBRGI7QUFFRVcsWUFBTTtBQUZSLEtBSjBCLEVBUTFCO0FBQ0VELFlBQU0sS0FBS1QsY0FEYjtBQUVFVSxZQUFNO0FBRlIsS0FSMEIsRUFZMUI7QUFDRUQsWUFBTSxLQUFLUixnQkFEYjtBQUVFUyxZQUFNO0FBRlIsS0FaMEIsQ0FBZCxDQUFkOztBQWtCQSxTQUFLQyxzQ0FBTCxHQUNFLCtCQURGOztBQUdBLFNBQUtDLHFDQUFMLEdBQ0UsOEJBREY7O0FBR0EsU0FBS0MsbUNBQUwsR0FDRSw0QkFERjs7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Q0FBUDtBQUNEOztBQUdELFdBQU84QixVQUFQO0FBRUQ7O0FBRURNLGNBQVk2QyxPQUFaLEVBQXFCO0FBQ25CLFFBQUkvQyxPQUFPLElBQUlHLElBQUosQ0FBUzRDLE9BQVQsQ0FBWDs7QUFFQSxXQUFRLEdBQUUvQyxLQUFLZ0QsT0FBTCxFQUFlLElBQUdoRCxLQUFLaUQsUUFBTCxLQUFrQixDQUFFLElBQUdqRCxLQUFLa0QsV0FBTCxFQUFtQixFQUF0RTtBQUNEOztBQTdkc0I7O0FBaWV6QixJQUFJQyxxQkFBcUIsSUFBSTdJLGtCQUFKLEVBQXpCOztrQkFFZTZJLGtCIiwiZmlsZSI6ImluZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgU1BJTkFMX1JFTEFUSU9OX1BUUl9MU1RfVFlQRSxcbiAgU3BpbmFsR3JhcGhTZXJ2aWNlXG59IGZyb20gXCJzcGluYWwtZW52LXZpZXdlci1ncmFwaC1zZXJ2aWNlXCI7XG5cbmltcG9ydCB7XG4gIEVRVUlQTUVOVFNfVE9fRUxFTUVOVF9SRUxBVElPTlxufSBmcm9tIFwic3BpbmFsLWVudi12aWV3ZXItcm9vbS1tYW5hZ2VyL2pzL3NlcnZpY2VcIjtcblxuaW1wb3J0IFZpc2l0TW9kZWwgZnJvbSBcIi4vbW9kZWxzL3Zpc2l0Lm1vZGVsLmpzXCI7XG5pbXBvcnQgRXZlbnRNb2RlbCBmcm9tIFwiLi9tb2RlbHMvZXZlbnQubW9kZWwuanNcIjtcbmltcG9ydCBUYXNrTW9kZWwgZnJvbSAnLi9tb2RlbHMvdGFzay5tb2RlbC5qcydcblxuaW1wb3J0IHtcbiAgUHRyLFxuICBMc3QsXG4gIE1vZGVsXG59IGZyb20gXCJzcGluYWwtY29yZS1jb25uZWN0b3Jqc190eXBlXCI7XG5cbmltcG9ydCBtb21lbnQgZnJvbSBcIm1vbWVudFwiO1xuXG5cbmNsYXNzIFNwaW5hbFZpc2l0U2VydmljZSB7XG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHRoaXMuVklTSVRfQ09OVEVYVF9OQU1FID0gXCIudmlzaXRfY29udGV4dFwiO1xuICAgIHRoaXMuQ09OVEVYVF9UWVBFID0gXCJ2aXNpdF9jb250ZXh0XCI7XG5cbiAgICB0aGlzLlZJU0lUX1RZUEUgPSBcInZpc2l0XCI7XG5cbiAgICB0aGlzLk1BSU5URU5BTkNFX1ZJU0lUID0gXCJNQUlOVEVOQU5DRV9WSVNJVFwiO1xuICAgIHRoaXMuUkVHVUxBVE9SWV9WSVNJVCA9IFwiUkVHVUxBVE9SWV9WSVNJVFwiO1xuICAgIHRoaXMuU0VDVVJJVFlfVklTSVQgPSBcIlNFQ1VSSVRZX1ZJU0lUXCI7XG4gICAgdGhpcy5ESUFHTk9TVElDX1ZJU0lUID0gXCJESUFHTk9TVElDX1ZJU0lUXCI7XG5cblxuICAgIHRoaXMuRVZFTlRfU1RBVEVTID0gT2JqZWN0LmZyZWV6ZSh7XG4gICAgICBkZWNsYXJlZDogXCJkw6ljbGFyw6lcIixcbiAgICAgIHByb2Nlc3Npbmc6IFwiZW5jb3Vyc1wiLFxuICAgICAgZG9uZTogXCLDqWZmZWN0dcOpXCJcbiAgICB9KVxuXG4gICAgdGhpcy5WSVNJVFMgPSBPYmplY3QuZnJlZXplKFt7XG4gICAgICAgIHR5cGU6IHRoaXMuTUFJTlRFTkFOQ0VfVklTSVQsXG4gICAgICAgIG5hbWU6IFwiTWFpbnRlbmFjZSB2aXNpdFwiXG4gICAgICB9LFxuICAgICAge1xuICAgICAgICB0eXBlOiB0aGlzLlJFR1VMQVRPUllfVklTSVQsXG4gICAgICAgIG5hbWU6IFwiUmVndWxhdG9yeSB2aXNpdFwiXG4gICAgICB9LFxuICAgICAge1xuICAgICAgICB0eXBlOiB0aGlzLlNFQ1VSSVRZX1ZJU0lULFxuICAgICAgICBuYW1lOiBcIlNlY3VyaXR5IFZpc2l0XCJcbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgIHR5cGU6IHRoaXMuRElBR05PU1RJQ19WSVNJVCxcbiAgICAgICAgbmFtZTogXCJEaWFnbm9zdGljIHZpc2l0XCJcbiAgICAgIH1cbiAgICBdKTtcblxuICAgIHRoaXMuTUFJTlRFTkFOQ0VfVklTSVRfRVZFTlRfU1RBVEVfUkVMQVRJT04gPVxuICAgICAgXCJtYWludGVuYW5jZVZpc2l0aGFzRXZlbnRTdGF0ZVwiO1xuXG4gICAgdGhpcy5SRUdVTEFUT1JZX1ZJU0lUX0VWRU5UX1NUQVRFX1JFTEFUSU9OID1cbiAgICAgIFwicmVndWxhdG9yeVZpc2l0aGFzRXZlbnRTdGF0ZVwiO1xuXG4gICAgdGhpcy5TRUNVUklUWV9WSVNJVF9FVkVOVF9TVEFURV9SRUxBVElPTiA9XG4gICAgICBcInNlY3VyaXR5VmlzaXRoYXNFdmVudFN0YXRlXCI7XG5cbiAgICB0aGlzLkRJQUdOT1NUSUNfVklTSVRfRVZFTlRfU1RBVEVfUkVMQVRJT04gPVxuICAgICAgXCJkaWFnbm9zdGljVmlzaXRoYXNFdmVudFN0YXRlXCI7XG5cblxuICAgIHRoaXMuR1JPVVBfVE9fVEFTSyA9IFwiaGFzVmlzaXRcIjtcblxuICAgIHRoaXMuVklTSVRfVE9fRVZFTlRfUkVMQVRJT04gPSBcInZpc2l0SGFzRXZlbnRcIjtcblxuICAgIHRoaXMuVklTSVRfVFlQRV9UT19HUk9VUF9SRUxBVElPTiA9IFwidmlzaXRIYXNHcm91cFwiO1xuICAgIHRoaXMuRVZFTlRfU1RBVEVfVE9fRVZFTlRfUkVMQVRJT04gPSBcImhhc0V2ZW50XCI7XG4gICAgdGhpcy5FVkVOVF9UT19UQVNLX1JFTEFUSU9OID0gXCJoYXNUYXNrXCI7XG5cbiAgfVxuXG5cbiAgZ2V0QWxsVmlzaXRzKCkge1xuICAgIHJldHVybiB0aGlzLlZJU0lUUztcbiAgfVxuXG4gIGFkZFZpc2l0T25Hcm91cChcbiAgICBncm91cElkLFxuICAgIHZpc2l0TmFtZSxcbiAgICBwZXJpb2RpY2l0eU51bWJlcixcbiAgICBwZXJpb2RpY2l0eU1lc3VyZSxcbiAgICB2aXNpdFR5cGUsXG4gICAgaW50ZXJ2ZW50aW9uTnVtYmVyLFxuICAgIGludGVydmVudGlvbk1lc3VyZSxcbiAgICBkZXNjcmlwdGlvblxuICApIHtcblxuICAgIC8vIGxldCB2aXNpdFR5cGUgPSBTcGluYWxHcmFwaFNlcnZpY2UuZ2V0SW5mbyh2aXNpdElkKS50eXBlLmdldCgpO1xuXG4gICAgcmV0dXJuIFNwaW5hbEdyYXBoU2VydmljZS5nZXRDaGlsZHJlbihncm91cElkLCBbdGhpcy5HUk9VUF9UT19UQVNLXSkudGhlbihcbiAgICAgIGNoaWxkcmVuID0+IHtcblxuICAgICAgICBsZXQgYXJnTm9kZUlkO1xuICAgICAgICBpZiAoY2hpbGRyZW4ubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgYXJnTm9kZUlkID0gU3BpbmFsR3JhcGhTZXJ2aWNlLmNyZWF0ZU5vZGUoe1xuICAgICAgICAgICAgbmFtZTogXCJtYWludGVuYW5jZVwiXG4gICAgICAgICAgfSk7XG5cbiAgICAgICAgICBTcGluYWxHcmFwaFNlcnZpY2UuYWRkQ2hpbGQoXG4gICAgICAgICAgICBncm91cElkLFxuICAgICAgICAgICAgYXJnTm9kZUlkLFxuICAgICAgICAgICAgdGhpcy5HUk9VUF9UT19UQVNLLFxuICAgICAgICAgICAgU1BJTkFMX1JFTEFUSU9OX1BUUl9MU1RfVFlQRVxuICAgICAgICAgICk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgbm9kZSA9XG4gICAgICAgICAgdHlwZW9mIGFyZ05vZGVJZCAhPT0gXCJ1bmRlZmluZWRcIiA/XG4gICAgICAgICAgU3BpbmFsR3JhcGhTZXJ2aWNlLmdldEluZm8oYXJnTm9kZUlkKSA6XG4gICAgICAgICAgY2hpbGRyZW5bMF07XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0UHRyVmFsdWUobm9kZSwgdmlzaXRUeXBlKS50aGVuKGxzdCA9PiB7XG5cbiAgICAgICAgICAvLyBsZXQgbm9kZUlkID0gdGhpcy5fcHJlcGFyZU5vZGUoZ3JvdXBJZCwgdmlzaXROYW1lLFxuICAgICAgICAgIC8vICAgcGVyaW9kaWNpdHlOdW1iZXIsXG4gICAgICAgICAgLy8gICBwZXJpb2RpY2l0eU1lc3VyZSxcbiAgICAgICAgICAvLyAgIHZpc2l0SWQsXG4gICAgICAgICAgLy8gICB2aXNpdFR5cGUsXG4gICAgICAgICAgLy8gICBpbnRlcnZlbnRpb25OdW1iZXIsXG4gICAgICAgICAgLy8gICBpbnRlcnZlbnRpb25NZXN1cmUsXG4gICAgICAgICAgLy8gICBkZXNjcmlwdGlvbik7XG5cbiAgICAgICAgICAvLyBTcGluYWxHcmFwaFNlcnZpY2UuYWRkQ2hpbGQodmlzaXRJZCwgbm9kZUlkLCB0aGlzXG4gICAgICAgICAgLy8gICAuVklTSVRfVE9fVEFTS19SRUxBVElPTiwgU1BJTkFMX1JFTEFUSU9OX1BUUl9MU1RfVFlQRSk7XG5cblxuXG4gICAgICAgICAgbGV0IHRhc2sgPSBuZXcgVmlzaXRNb2RlbCh2aXNpdE5hbWUsIHBlcmlvZGljaXR5TnVtYmVyLFxuICAgICAgICAgICAgcGVyaW9kaWNpdHlNZXN1cmUsIHZpc2l0VHlwZSwgaW50ZXJ2ZW50aW9uTnVtYmVyLFxuICAgICAgICAgICAgaW50ZXJ2ZW50aW9uTWVzdXJlLCBkZXNjcmlwdGlvbik7XG5cbiAgICAgICAgICBsZXQgbm9kZUlkID0gU3BpbmFsR3JhcGhTZXJ2aWNlLmNyZWF0ZU5vZGUoe1xuICAgICAgICAgICAgZ3JvdXBJZDogZ3JvdXBJZCxcbiAgICAgICAgICAgIG5hbWU6IHZpc2l0TmFtZSxcbiAgICAgICAgICAgIHBlcmlvZGljaXR5OiB7XG4gICAgICAgICAgICAgIG51bWJlcjogdGFzay5wZXJpb2RpY2l0eS5udW1iZXIuZ2V0KCksXG4gICAgICAgICAgICAgIG1lc3VyZTogdGFzay5wZXJpb2RpY2l0eS5tZXN1cmUuZ2V0KClcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBpbnRlcnZlbnRpb246IHtcbiAgICAgICAgICAgICAgbnVtYmVyOiB0YXNrLmludGVydmVudGlvbi5udW1iZXIuZ2V0KCksXG4gICAgICAgICAgICAgIG1lc3VyZTogdGFzay5pbnRlcnZlbnRpb24ubWVzdXJlLmdldCgpXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgdmlzaXRUeXBlOiB2aXNpdFR5cGUsXG4gICAgICAgICAgICBkZXNjcmlwdGlvbjogZGVzY3JpcHRpb25cblxuICAgICAgICAgIH0sIHRhc2spO1xuXG5cbiAgICAgICAgICBsZXQgcmVhbE5vZGUgPSBTcGluYWxHcmFwaFNlcnZpY2UuZ2V0UmVhbE5vZGUobm9kZUlkKTtcblxuICAgICAgICAgIGxzdC5wdXNoKHJlYWxOb2RlKTtcblxuICAgICAgICAgIHJldHVybiByZWFsTm9kZS5pbmZvO1xuXG4gICAgICAgIH0pXG4gICAgICB9XG4gICAgKTtcblxuICAgIC8vIGxldCB0YXNrID0gbmV3IFZpc2l0TW9kZWwodmlzaXROYW1lLCBiZWdpbkRhdGUsIHBlcmlvZGljaXR5TnVtYmVyLFxuICAgIC8vICAgcGVyaW9kaWNpdHlNZXN1cmUsXG4gICAgLy8gICB2aXNpdElkLCB2aXNpdE5hbWUpO1xuXG4gICAgLy8gbGV0IG5vZGVJZCA9IFNwaW5hbEdyYXBoU2VydmljZS5jcmVhdGVOb2RlKHtcbiAgICAvLyAgIG5hbWU6IHRhc2tOYW1lLFxuICAgIC8vICAgdHlwZTogXCJ0YXNrXCIsXG4gICAgLy8gICB2aXNpdElkOiB2aXNpdElkXG4gICAgLy8gfSwgdGFzayk7XG5cbiAgICAvLyAvLyByZXR1cm4gU3BpbmFsR3JhcGhTZXJ2aWNlLmFkZENoaWxkKGdyb3VwSWQsIG5vZGVJZCwgdGhpcy5HUk9VUF9UT19UQVNLLFxuICAgIC8vIC8vICAgU1BJTkFMX1JFTEFUSU9OX1BUUl9MU1RfVFlQRSkudGhlbihlbCA9PiB7XG4gICAgLy8gLy8gICBpZiAoZWwpIHtcbiAgICAvLyAvLyAgICAgdGhpcy5hZGRPcGVyYXRpb25zKGdyb3VwSWQsIG5vZGVJZCwgYmVnaW5EYXRlKTtcbiAgICAvLyAvLyAgICAgcmV0dXJuIHRhc2s7XG4gICAgLy8gLy8gICB9XG4gICAgLy8gLy8gfSlcbiAgfVxuXG4gIGdldFB0clZhbHVlKG5vZGUsIHB0ck5hbWUpIHtcbiAgICBsZXQgcmVhbE5vZGUgPSBTcGluYWxHcmFwaFNlcnZpY2UuZ2V0UmVhbE5vZGUobm9kZS5pZC5nZXQoKSk7XG5cbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICAgIGlmICghcmVhbE5vZGUuaW5mb1twdHJOYW1lXSkge1xuICAgICAgICByZWFsTm9kZS5pbmZvLmFkZF9hdHRyKHB0ck5hbWUsIHtcbiAgICAgICAgICB0YXNrczogbmV3IFB0cihuZXcgTHN0KCkpXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICByZWFsTm9kZS5pbmZvW3B0ck5hbWVdLnRhc2tzLmxvYWQoKHZhbHVlKSA9PiB7XG4gICAgICAgIHJldHVybiByZXNvbHZlKHZhbHVlKTtcbiAgICAgIH0pXG4gICAgfSlcblxuXG4gIH1cblxuICBnZXRHcm91cFZpc2l0cyhncm91cElkLCB2aXNpdHlUeXBlKSB7XG4gICAgcmV0dXJuIFNwaW5hbEdyYXBoU2VydmljZS5nZXRDaGlsZHJlbihncm91cElkLCBbdGhpcy5HUk9VUF9UT19UQVNLXSkudGhlbihcbiAgICAgIHJlcyA9PiB7XG4gICAgICAgIGxldCBub2RlSWQ7XG4gICAgICAgIGlmIChyZXMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgbm9kZUlkID0gU3BpbmFsR3JhcGhTZXJ2aWNlLmNyZWF0ZU5vZGUoe1xuICAgICAgICAgICAgbmFtZTogXCJtYWludGVuYW5jZVwiXG4gICAgICAgICAgfSk7XG5cbiAgICAgICAgICBTcGluYWxHcmFwaFNlcnZpY2UuYWRkQ2hpbGQoXG4gICAgICAgICAgICBncm91cElkLFxuICAgICAgICAgICAgbm9kZUlkLFxuICAgICAgICAgICAgdGhpcy5HUk9VUF9UT19UQVNLLFxuICAgICAgICAgICAgU1BJTkFMX1JFTEFUSU9OX1BUUl9MU1RfVFlQRVxuICAgICAgICAgICk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgbm9kZSA9XG4gICAgICAgICAgdHlwZW9mIG5vZGVJZCAhPT0gXCJ1bmRlZmluZWRcIiA/XG4gICAgICAgICAgU3BpbmFsR3JhcGhTZXJ2aWNlLmdldEluZm8obm9kZUlkKSA6XG4gICAgICAgICAgcmVzWzBdO1xuXG4gICAgICAgIHJldHVybiB0aGlzLmdldFB0clZhbHVlKG5vZGUsIHZpc2l0eVR5cGUpO1xuICAgICAgfSk7XG5cbiAgfVxuXG5cblxuICBnZW5lcmF0ZUV2ZW50KHZpc2l0VHlwZSwgZ3JvdXBJZCwgYmVnaW5EYXRlLCBlbmREYXRlLCBldmVudHNEYXRhKSB7XG5cbiAgICByZXR1cm4gdGhpcy5jcmVhdGVWaXNpdENvbnRleHQodmlzaXRUeXBlKVxuICAgICAgLnRoZW4oZWwgPT4ge1xuXG4gICAgICAgIHJldHVybiB0aGlzLmxpbmtHcm91cFRvVmlzdENvbnRleHQoZWwuaWQuZ2V0KCksIGdyb3VwSWQpLnRoZW4oXG4gICAgICAgICAgcmVzID0+IHtcblxuICAgICAgICAgICAgaWYgKHJlcykge1xuICAgICAgICAgICAgICB0aGlzLmdldEV2ZW50U3RhdGVOb2RlKGVsLmlkLmdldCgpLCBncm91cElkLCB0aGlzXG4gICAgICAgICAgICAgICAgLkVWRU5UX1NUQVRFUy5kZWNsYXJlZCkudGhlbihzdGF0ZU5vZGUgPT4ge1xuXG4gICAgICAgICAgICAgICAgbGV0IGlkID0gc3RhdGVOb2RlLmlkLmdldCgpO1xuXG4gICAgICAgICAgICAgICAgZXZlbnRzRGF0YS5mb3JFYWNoKGV2ZW50SW5mbyA9PiB7XG4gICAgICAgICAgICAgICAgICBsZXQgZXZlbnRzRGF0ZSA9IHRoaXMuX2dldERhdGUoYmVnaW5EYXRlLFxuICAgICAgICAgICAgICAgICAgICBlbmREYXRlLFxuICAgICAgICAgICAgICAgICAgICBldmVudEluZm8ucGVyaW9kTnVtYmVyLCBldmVudEluZm9cbiAgICAgICAgICAgICAgICAgICAgLnBlcmlvZE1lc3VyZSk7XG5cbiAgICAgICAgICAgICAgICAgIGV2ZW50c0RhdGUuZm9yRWFjaCgoZGF0ZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFkZEV2ZW50KGVsLmlkLmdldCgpLCBncm91cElkLCBpZCxcbiAgICAgICAgICAgICAgICAgICAgICBldmVudEluZm8sXG4gICAgICAgICAgICAgICAgICAgICAgYEV2ZW50XyR7ZXZlbnRJbmZvLm5hbWV9XyR7dGhpcy5fZm9ybWF0RGF0ZShkYXRlKX1gLFxuICAgICAgICAgICAgICAgICAgICAgIG5ldyBEYXRlKGRhdGUpLmdldFRpbWUoKVxuICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIH0pXG5cbiAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KTtcbiAgICAgIH0pXG4gICAgICAuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgY29uc29sZS5sb2coZXJyKTtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShlcnIpO1xuICAgICAgfSlcblxuXG4gIH1cblxuXG4gIGFkZEV2ZW50KHZpc2l0VHlwZUNvbnRleHRJZCwgZ3JvdXBJZCwgc3RhdGVJZCwgdmlzaXRJbmZvLCBuYW1lLCBkYXRlKSB7XG5cblxuICAgIGxldCBzdGF0ZSA9IFNwaW5hbEdyYXBoU2VydmljZS5nZXRJbmZvKHN0YXRlSWQpLm5hbWUuZ2V0KCk7XG5cbiAgICBsZXQgZXZlbnQgPSBuZXcgRXZlbnRNb2RlbChuYW1lLCBkYXRlLCBzdGF0ZSwgZ3JvdXBJZCk7XG5cbiAgICBsZXQgZXZlbnROb2RlSWQgPSBTcGluYWxHcmFwaFNlcnZpY2UuY3JlYXRlTm9kZSh7XG4gICAgICBuYW1lOiBuYW1lLFxuICAgICAgZGF0ZTogZGF0ZSxcbiAgICAgIHN0YXRlOiBzdGF0ZSxcbiAgICAgIGdyb3VwSWQ6IGdyb3VwSWQsXG4gICAgICB2aXNpdElkOiB2aXNpdEluZm8uaWRcbiAgICB9LCBldmVudCk7XG5cblxuICAgIHJldHVybiBTcGluYWxHcmFwaFNlcnZpY2UuYWRkQ2hpbGRJbkNvbnRleHQoc3RhdGVJZCwgZXZlbnROb2RlSWQsXG4gICAgICB2aXNpdFR5cGVDb250ZXh0SWQsIHRoaXMuRVZFTlRfU1RBVEVfVE9fRVZFTlRfUkVMQVRJT04sXG4gICAgICBTUElOQUxfUkVMQVRJT05fUFRSX0xTVF9UWVBFXG4gICAgKS50aGVuKGVsID0+IHtcbiAgICAgIGlmIChlbCkgcmV0dXJuIGV2ZW50Tm9kZUlkO1xuICAgIH0pLnRoZW4oZXZlbnRJZCA9PiB7XG5cbiAgICAgIGlmICh0eXBlb2YgZXZlbnRJZCAhPT0gXCJ1bmRlZmluZWRcIikge1xuICAgICAgICByZXR1cm4gU3BpbmFsR3JhcGhTZXJ2aWNlLmdldENoaWxkcmVuKGdyb3VwSWQsIFtcbiAgICAgICAgICBFUVVJUE1FTlRTX1RPX0VMRU1FTlRfUkVMQVRJT05cbiAgICAgICAgXSkudGhlbihcbiAgICAgICAgICBjaGlsZHJlbiA9PiB7XG5cbiAgICAgICAgICAgIGNoaWxkcmVuLm1hcChjaGlsZCA9PiB7XG4gICAgICAgICAgICAgIGxldCBuYW1lID0gYCR7dmlzaXRJbmZvLm5hbWV9X18ke2NoaWxkLm5hbWUuZ2V0KCl9YDtcbiAgICAgICAgICAgICAgbGV0IHRhc2sgPSBuZXcgVGFza01vZGVsKG5hbWUsIGNoaWxkLmRiaWRcbiAgICAgICAgICAgICAgICAuZ2V0KCksIGNoaWxkLmJpbUZpbGVJZC5nZXQoKSwgdmlzaXRJbmZvLm5hbWUsIDApO1xuXG5cbiAgICAgICAgICAgICAgbGV0IHRhc2tJZCA9IFNwaW5hbEdyYXBoU2VydmljZS5jcmVhdGVOb2RlKHtcbiAgICAgICAgICAgICAgICBuYW1lOiBuYW1lLFxuICAgICAgICAgICAgICAgIGRiSWQ6IGNoaWxkLmRiaWQuZ2V0KCksXG4gICAgICAgICAgICAgICAgYmltRmlsZUlkOiBjaGlsZC5iaW1GaWxlSWQuZ2V0KCksXG4gICAgICAgICAgICAgICAgdGFza05hbWU6IHZpc2l0SW5mby5uYW1lLFxuICAgICAgICAgICAgICAgIHZpc2l0SWQ6IHZpc2l0SW5mby5pZCxcbiAgICAgICAgICAgICAgICBzdGF0ZTogdGFzay5zdGF0ZS5nZXQoKVxuICAgICAgICAgICAgICB9LCB0YXNrKTtcblxuICAgICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwoW1NwaW5hbEdyYXBoU2VydmljZVxuICAgICAgICAgICAgICAgIC5hZGRDaGlsZEluQ29udGV4dChcbiAgICAgICAgICAgICAgICAgIGV2ZW50SWQsIHRhc2tJZCwgdmlzaXRUeXBlQ29udGV4dElkLCB0aGlzXG4gICAgICAgICAgICAgICAgICAuRVZFTlRfVE9fVEFTS19SRUxBVElPTixcbiAgICAgICAgICAgICAgICAgIFNQSU5BTF9SRUxBVElPTl9QVFJfTFNUX1RZUEUpLFxuICAgICAgICAgICAgICAgIFNwaW5hbEdyYXBoU2VydmljZS5hZGRDaGlsZChcbiAgICAgICAgICAgICAgICAgIHZpc2l0SW5mb1xuICAgICAgICAgICAgICAgICAgLmlkLFxuICAgICAgICAgICAgICAgICAgZXZlbnRJZCxcbiAgICAgICAgICAgICAgICAgIHRoaXMuVklTSVRfVE9fRVZFTlRfUkVMQVRJT04sXG4gICAgICAgICAgICAgICAgICBTUElOQUxfUkVMQVRJT05fUFRSX0xTVF9UWVBFKVxuICAgICAgICAgICAgICBdKVxuXG4gICAgICAgICAgICB9KVxuXG5cblxuICAgICAgICAgIH0pXG4gICAgICB9XG5cbiAgICB9KVxuXG4gIH1cblxuXG4gIGNyZWF0ZVZpc2l0Q29udGV4dCh2aXNpdFR5cGUpIHtcblxuICAgIGxldCB2aXNpdCA9IHRoaXMuVklTSVRTLmZpbmQoZWwgPT4ge1xuICAgICAgcmV0dXJuIGVsLnR5cGUgPT09IHZpc2l0VHlwZTtcbiAgICB9KVxuXG4gICAgaWYgKHR5cGVvZiB2aXNpdCAhPT0gXCJ1bmRlZmluZWRcIikge1xuICAgICAgY29uc3QgY29udGV4dE5hbWUgPSBgJHt2aXNpdC5uYW1lfWA7XG5cbiAgICAgIGxldCBjb250ZXh0ID0gU3BpbmFsR3JhcGhTZXJ2aWNlLmdldENvbnRleHQoY29udGV4dE5hbWUpO1xuICAgICAgaWYgKHR5cGVvZiBjb250ZXh0ICE9PSBcInVuZGVmaW5lZFwiKSByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGNvbnRleHRcbiAgICAgICAgLmluZm8pO1xuXG4gICAgICByZXR1cm4gU3BpbmFsR3JhcGhTZXJ2aWNlLmFkZENvbnRleHQoY29udGV4dE5hbWUsIHZpc2l0VHlwZSwgbmV3IE1vZGVsKHtcbiAgICAgICAgbmFtZTogdGhpcy5WSVNJVF9DT05URVhUX05BTUVcbiAgICAgIH0pKS50aGVuKGNvbnRleHRDcmVhdGVkID0+IHtcbiAgICAgICAgcmV0dXJuIGNvbnRleHRDcmVhdGVkLmluZm87XG4gICAgICB9KTtcblxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoXCJ2aXNpdE5vdEZvdW5kXCIpO1xuICAgIH1cblxuICB9XG5cblxuICBsaW5rR3JvdXBUb1Zpc3RDb250ZXh0KHZpc2l0Q29udGV4dElkLCBncm91cElkKSB7XG4gICAgcmV0dXJuIFNwaW5hbEdyYXBoU2VydmljZS5nZXRDaGlsZHJlbih2aXNpdENvbnRleHRJZCwgW3RoaXNcbiAgICAgIC5WSVNJVF9UWVBFX1RPX0dST1VQX1JFTEFUSU9OXG4gICAgXSkudGhlbihjaGlsZHJlbiA9PiB7XG5cbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgY29uc3QgY2hpbGQgPSBjaGlsZHJlbltpXS5pZC5nZXQoKTtcbiAgICAgICAgaWYgKGNoaWxkID09PSBncm91cElkKSByZXR1cm4gdHJ1ZTtcbiAgICAgIH1cblxuICAgIH0pLnRoZW4oZWwgPT4ge1xuXG4gICAgICBpZiAodHlwZW9mIGVsID09PSBcInVuZGVmaW5lZFwiKSB7XG5cbiAgICAgICAgcmV0dXJuIFNwaW5hbEdyYXBoU2VydmljZS5hZGRDaGlsZEluQ29udGV4dCh2aXNpdENvbnRleHRJZCxcbiAgICAgICAgICAgIGdyb3VwSWQsIHZpc2l0Q29udGV4dElkLCB0aGlzLlZJU0lUX1RZUEVfVE9fR1JPVVBfUkVMQVRJT04sXG4gICAgICAgICAgICBTUElOQUxfUkVMQVRJT05fUFRSX0xTVF9UWVBFKVxuICAgICAgICAgIC50aGVuKFxuICAgICAgICAgICAgYXN5bmMgcmVzID0+IHtcblxuICAgICAgICAgICAgICBpZiAocmVzKSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5nZXRFdmVudFN0YXRlTm9kZSh2aXNpdENvbnRleHRJZCwgZ3JvdXBJZCxcbiAgICAgICAgICAgICAgICAgIHRoaXMuRVZFTlRfU1RBVEVTXG4gICAgICAgICAgICAgICAgICAucHJvY2Vzc2luZyk7XG4gICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5nZXRFdmVudFN0YXRlTm9kZSh2aXNpdENvbnRleHRJZCwgZ3JvdXBJZCxcbiAgICAgICAgICAgICAgICAgIHRoaXMuRVZFTlRfU1RBVEVTXG4gICAgICAgICAgICAgICAgICAuZG9uZSk7XG4gICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICByZXR1cm4gcmVzO1xuXG4gICAgICAgICAgICB9KVxuICAgICAgfSBlbHNlIHtcblxuICAgICAgICByZXR1cm4gZWw7XG4gICAgICB9XG5cbiAgICB9KVxuICB9XG5cblxuICBnZXRFdmVudFN0YXRlTm9kZSh2aXNpdENvbnRleHRJZCwgZ3JvdXBJZCwgZXZlbnRTYXRlKSB7XG5cbiAgICBsZXQgY29udGV4dFR5cGUgPSBTcGluYWxHcmFwaFNlcnZpY2UuZ2V0SW5mbyh2aXNpdENvbnRleHRJZCkudHlwZS5nZXQoKTtcbiAgICBsZXQgcmVsYXRpb25OYW1lO1xuXG4gICAgc3dpdGNoIChjb250ZXh0VHlwZSkge1xuICAgICAgY2FzZSB0aGlzLk1BSU5URU5BTkNFX1ZJU0lUOlxuICAgICAgICByZWxhdGlvbk5hbWUgPSB0aGlzLk1BSU5URU5BTkNFX1ZJU0lUX0VWRU5UX1NUQVRFX1JFTEFUSU9OO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgdGhpcy5TRUNVUklUWV9WSVNJVDpcbiAgICAgICAgcmVsYXRpb25OYW1lID0gdGhpcy5TRUNVUklUWV9WSVNJVF9FVkVOVF9TVEFURV9SRUxBVElPTjtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIHRoaXMuRElBR05PU1RJQ19WSVNJVDpcbiAgICAgICAgcmVsYXRpb25OYW1lID0gdGhpcy5ESUFHTk9TVElDX1ZJU0lUX0VWRU5UX1NUQVRFX1JFTEFUSU9OO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgdGhpcy5SRUdVTEFUT1JZX1ZJU0lUOlxuICAgICAgICByZWxhdGlvbk5hbWUgPSB0aGlzLlJFR1VMQVRPUllfVklTSVRfRVZFTlRfU1RBVEVfUkVMQVRJT047XG4gICAgICAgIGJyZWFrO1xuXG4gICAgfVxuXG5cbiAgICByZXR1cm4gU3BpbmFsR3JhcGhTZXJ2aWNlLmdldENoaWxkcmVuKGdyb3VwSWQsIFtyZWxhdGlvbk5hbWVdKVxuICAgICAgLnRoZW4oY2hpbGRyZW4gPT4ge1xuXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICBjb25zdCBuYW1lID0gY2hpbGRyZW5baV0ubmFtZS5nZXQoKTtcblxuICAgICAgICAgIGlmIChuYW1lID09PSBldmVudFNhdGUpIHtcbiAgICAgICAgICAgIHJldHVybiBjaGlsZHJlbltpXTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgfVxuXG4gICAgICB9KS50aGVuKGVsID0+IHtcbiAgICAgICAgaWYgKHR5cGVvZiBlbCA9PT0gXCJ1bmRlZmluZWRcIikge1xuICAgICAgICAgIGxldCBhcmdOb2RlSWQgPSBTcGluYWxHcmFwaFNlcnZpY2UuY3JlYXRlTm9kZSh7XG4gICAgICAgICAgICBuYW1lOiBldmVudFNhdGUsXG4gICAgICAgICAgICBzdGF0ZTogZXZlbnRTYXRlLFxuICAgICAgICAgICAgdHlwZTogXCJFdmVudFN0YXRlXCJcbiAgICAgICAgICB9KTtcblxuICAgICAgICAgIHJldHVybiBTcGluYWxHcmFwaFNlcnZpY2UuYWRkQ2hpbGRJbkNvbnRleHQoZ3JvdXBJZCxcbiAgICAgICAgICAgIGFyZ05vZGVJZCwgdmlzaXRDb250ZXh0SWQsXG4gICAgICAgICAgICByZWxhdGlvbk5hbWUsXG4gICAgICAgICAgICBTUElOQUxfUkVMQVRJT05fUFRSX0xTVF9UWVBFKS50aGVuKHJlcyA9PiB7XG4gICAgICAgICAgICBpZiAocmVzKSByZXR1cm4gU3BpbmFsR3JhcGhTZXJ2aWNlLmdldEluZm8oXG4gICAgICAgICAgICAgIGFyZ05vZGVJZCk7XG4gICAgICAgICAgfSlcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4gZWw7XG4gICAgICAgIH1cblxuICAgICAgfSlcbiAgfVxuXG5cbiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gIC8vICAgICAgICAgICAgICAgICAgICAgICAgICAgIFBSSVZBVEVTICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL1xuICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuXG4gIF9nZXREYXRlKGJlZ2luRGF0ZSwgZW5kRGF0ZSwgcGVyaW9kTnVtYmVyLCBwZXJpb2RNZXN1cmUpIHtcblxuICAgIGxldCBtZXN1cmUgPSBbJ2RheXMnLCAnd2Vla3MnLCAnbW9udGhzJywgJ3llYXJzJ11bcGVyaW9kTWVzdXJlXTtcblxuICAgIGxldCBldmVudHNEYXRlID0gW107XG5cbiAgICBsZXQgZGF0ZSA9IG1vbWVudChiZWdpbkRhdGUpO1xuICAgIGxldCBlbmQgPSBtb21lbnQoZW5kRGF0ZSk7XG5cbiAgICB3aGlsZSAoZW5kLmRpZmYoZGF0ZSkgPj0gMCkge1xuICAgICAgZXZlbnRzRGF0ZS5wdXNoKGRhdGUudG9EYXRlKCkpO1xuXG4gICAgICBkYXRlID0gZGF0ZS5hZGQocGVyaW9kTnVtYmVyLCBtZXN1cmUpO1xuICAgIH1cblxuXG4gICAgcmV0dXJuIGV2ZW50c0RhdGU7XG5cbiAgfVxuXG4gIF9mb3JtYXREYXRlKGFyZ0RhdGUpIHtcbiAgICBsZXQgZGF0ZSA9IG5ldyBEYXRlKGFyZ0RhdGUpO1xuXG4gICAgcmV0dXJuIGAke2RhdGUuZ2V0RGF0ZSgpfS8ke2RhdGUuZ2V0TW9udGgoKSArIDF9LyR7ZGF0ZS5nZXRGdWxsWWVhcigpfWA7XG4gIH1cblxufVxuXG5sZXQgc3BpbmFsVmlzaXRTZXJ2aWNlID0gbmV3IFNwaW5hbFZpc2l0U2VydmljZSgpO1xuXG5leHBvcnQgZGVmYXVsdCBzcGluYWxWaXNpdFNlcnZpY2U7Il19